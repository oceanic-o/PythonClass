var ink;(()=>{"use strict";var t={d:(e,i)=>{for(var n in i)t.o(i,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{inkCanvasFactoryGlobal:()=>bn,inkDryStoreFactoryGlobal:()=>Ln,inkStrokeRasterizerFactoryGlobal:()=>Cn});var i,n={logActivity:function(t,e,i,n){}};function s(t){n=t}function o(){return-1!==navigator.userAgent.indexOf("MSIE")||-1!==navigator.userAgent.indexOf("Trident")}function r(){return-1!==navigator.userAgent.indexOf("Firefox")}function a(){return/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1}function h(){return!o()&&("mix-blend-mode","darken",void 0!==window.CSS&&window.CSS.supports("mix-blend-mode","darken"))}function u(t){t.style.pointerEvents="auto"}function c(t){t.style.pointerEvents="none"}function l(t){return new HapticsPredefinedWaveform(t)}!function(t){t[t.WAVEFORM_CLICK=4099]="WAVEFORM_CLICK",t[t.WAVEFORM_BUZZ_CONTINUOUS=4100]="WAVEFORM_BUZZ_CONTINUOUS",t[t.WAVEFORM_RUMBLE_CONTINUOUS=4101]="WAVEFORM_RUMBLE_CONTINUOUS",t[t.WAVEFORM_PRESS=4102]="WAVEFORM_PRESS",t[t.WAVEFORM_RELEASE=4103]="WAVEFORM_RELEASE",t[t.WAVEFORM_HOVER=4104]="WAVEFORM_HOVER",t[t.WAVEFORM_SUCCESS=4105]="WAVEFORM_SUCCESS",t[t.WAVEFORM_ERROR=4106]="WAVEFORM_ERROR",t[t.WAVEFORM_INK_CONTINUOUS=4107]="WAVEFORM_INK_CONTINUOUS",t[t.WAVEFORM_PENCIL_CONTINUOUTS=4108]="WAVEFORM_PENCIL_CONTINUOUTS",t[t.WAVEFORM_MARKER_CONTINUOUS=4109]="WAVEFORM_MARKER_CONTINUOUS",t[t.WAVEFORM_CHISEL_MARKER_CONTINUOUS=4110]="WAVEFORM_CHISEL_MARKER_CONTINUOUS",t[t.WAVEFORM_BRUSH_CONTINUOUS=4111]="WAVEFORM_BRUSH_CONTINUOUS",t[t.WAVEFORM_ERASER_CONTINUOUS=4112]="WAVEFORM_ERASER_CONTINUOUS",t[t.WAVEFORM_FIRST_CUSTOM_VENDOR_DEFINED=10752]="WAVEFORM_FIRST_CUSTOM_VENDOR_DEFINED",t[t.WAVEFORM_SECOND_CUSTOM_VENDOR_DEFINED=8479]="WAVEFORM_SECOND_CUSTOM_VENDOR_DEFINED",t[t.WAVEFORM_GALAXY_PEN_CONTINUOUS=4113]="WAVEFORM_GALAXY_PEN_CONTINUOUS"}(i||(i={}));class p{constructor(){this.isPointerDown=!1}play(t){if(void 0===this.haptics)return;const e=t();void 0!==e&&this.haptics.play(e)}stop(){var t;null===(t=this.haptics)||void 0===t||t.stop()}onPointerDown(t){var e;this.isPointerDown=!0,this.extractHapticsDevice(t),null===(e=this.output)||void 0===e||e.onPointerDown(t)}onPointerMove(t){var e;this.extractHapticsDevice(t),null===(e=this.output)||void 0===e||e.onPointerMove(t)}onPointerUp(t){var e;this.isPointerDown=!1,this.extractHapticsDevice(t),null===(e=this.output)||void 0===e||e.onPointerUp(t)}extractHapticsDevice(t){var e;this.haptics=null!==(e=t.haptics)&&void 0!==e?e:void 0}}const d={r:0,g:0,b:0,a:1},f={r:255,g:255,b:255,a:1};function g(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}class m{constructor(t){this.color=g(void 0!==t?t:d)}setRed(t){return this.color.r=t,this}setGreen(t){return this.color.g=t,this}setBlue(t){return this.color.b=t,this}setAlpha(t){return this.color.a=t,this}setHexRGB(t){return 7===t.length&&"#"===t[0]&&(this.color.r=parseInt(t.substr(1,2),16),this.color.g=parseInt(t.substr(3,2),16),this.color.b=parseInt(t.substr(5,2),16)),this}build(){return g(this.color)}}const v={type:0},y={width:4,height:4,color:d,effect:v,tip:"ellipse",rasterOperation:"copy"};function S(t){return{width:t.width,height:t.height,color:t.color,effect:t.effect,tip:t.tip,rasterOperation:t.rasterOperation}}class w{constructor(t){this.attributes=S(void 0!==t?t:y)}setWidth(t){return this.attributes.width=t,this}setHeight(t){return this.attributes.height=t,this}setColor(t){return this.attributes.color=t,this}setEffect(t){return this.attributes.effect=t,this}setTip(t){return this.attributes.tip=t,this}setRasterOperation(t){return this.attributes.rasterOperation=t,this}build(){return S(this.attributes)}}let P=!1;class k{constructor(t,e,i){this.penType="pen",this.cachedPenTimeInSec=0,this.lastCountedTimeInSec=0,this.penEnterTimeInSec=0,this.penLeaveTimeInSec=0,this.onUnload=()=>{clearInterval(this.logIntervalId),this.logPenUsage()},this.pointerEnter=t=>{t.pointerType===this.penType&&(this.penEnterTimeInSec||(this.penEnterTimeInSec=Math.floor(Date.now()/1e3),this.penEnterTimeInSec<=this.lastCountedTimeInSec&&(this.penEnterTimeInSec=this.lastCountedTimeInSec),this.penLeaveTimeInSec=0))},this.pointerLeave=()=>{const t=Math.ceil(Date.now()/1e3);if(this.penEnterTimeInSec&&t>this.lastCountedTimeInSec){this.penLeaveTimeInSec=t;const e=this.penLeaveTimeInSec-this.penEnterTimeInSec;this.cachedPenTimeInSec+=e}this.lastCountedTimeInSec=t,this.penEnterTimeInSec=0},this.visibilityChange=()=>{this.window.document.hidden&&this.pointerLeave()},this.logger=t,this.window=null!=i?i:window,this.registerPenEvents();const n=void 0!==e?e:1;this.logIntervalId=this.window.setInterval(this.logPenUsage.bind(this),60*n*1e3)}registerPenEvents(){this.window.document.body.addEventListener("pointerenter",this.pointerEnter),this.window.document.body.addEventListener("pointerleave",this.pointerLeave),this.window.document.addEventListener("visibilitychange",this.visibilityChange),this.window.addEventListener("beforeunload",this.onUnload)}logPenUsage(){0!==this.cachedPenTimeInSec&&(this.logger.logActivity("PenMinutes",1e3*this.cachedPenTimeInSec,["PenInputSec"],[this.cachedPenTimeInSec]),this.cachedPenTimeInSec=0)}}var x;!function(t){t.Pen="pen",t.Pencil="pencil",t.Highlighter="highlighter",t.Erase="erase",t.ActionPen="actionPen",t.Laser="laser",t.Lasso="lasso",t.RemoteInk="remoteInk"}(x||(x={}));class b{constructor(t,e,i){this.penType="pen",this.mouseType="mouse",this.remoteInputType="unknown",this.logDataNames=["InputType","Activity","InkSec"],this.inkLogName="InkMinutes",this.cachedInkTimeInSec=0,this.cachedRemoteInkTimeInSec=0,this.cachedInkStartTime=0,this.lastInkInSec=0,this.isPointerDown=!1,this.isEventRegistered=!1,this.onPointerDown=t=>{void 0!==this.lastActivity&&(this.countDistinctSecond(t.pointerType),this.isPointerDown=!0)},this.onPointerMove=t=>{void 0!==this.lastActivity&&(void 0===this.lastInputType&&(this.lastInputType=t.pointerType),this.shouldCountPointerMove(t)&&this.countDistinctSecond(t.pointerType))},this.onPointerUp=t=>{void 0!==this.lastActivity&&(this.countDistinctSecond(t.pointerType),this.isPointerDown=!1,this.setLocalInkLogTimerHandle(this.window.setTimeout(this.logLocalInkMinute,1e3*this.logIntervalInSec)))},this.beforeUnload=()=>{this.logLocalInkMinute(),this.resetLocalInkCache(),this.logRemoteInkMinute()},this.logLocalInkMinute=()=>{if(0===this.cachedInkTimeInSec)return;if(void 0===this.lastActivity||void 0===this.lastInputType)return void(this.cachedInkTimeInSec=0);const t=[this.lastInputType,this.lastActivity,this.cachedInkTimeInSec];this.logger.logActivity(this.inkLogName,1e3*this.cachedInkTimeInSec,this.logDataNames,t),this.cachedInkTimeInSec=0},this.logRemoteInkMinute=()=>{if(0===this.cachedRemoteInkTimeInSec)return;const t=[this.remoteInputType,x.RemoteInk,this.cachedRemoteInkTimeInSec];this.logger.logActivity(this.inkLogName,1e3*this.cachedRemoteInkTimeInSec,this.logDataNames,t),this.cachedRemoteInkTimeInSec=0},this.logger=t,this.logIntervalInSec=60*(void 0===e?1:e),this.window=null!=i?i:window}activate(t){this.isEventRegistered&&this.unregisterEvents(),this.wetCanvas=t,this.registerEvents()}deactivate(){this.isEventRegistered&&this.unregisterEvents(),this.logLocalInkMinute(),this.logRemoteInkMinute()}start(t){this.lastActivity!==t&&(void 0!==this.lastActivity&&this.end(),this.lastActivity=t)}end(){this.logLocalInkMinute(),this.resetLocalInkCache()}onRemoteWetStart(){this.countRemoteWetTime(!1)}onRemoteWetAppend(){this.countRemoteWetTime(!1)}onRemoteWetEnd(){this.countRemoteWetTime(!0)}onRemoteLaserStart(t){this.isPointerDown||1!==t&&2!==t||this.countDistinctSecond(this.remoteInputType)}onRemoteLaserMove(t){this.isPointerDown||(1!==t&&2!==t||this.countDistinctSecond(this.remoteInputType),1===t&&this.cachedRemoteInkTimeInSec>this.logIntervalInSec&&this.logRemoteInkMinute())}onRemoteLaserEnd(){this.isPointerDown||(this.countDistinctSecond(this.remoteInputType),this.setRemoteInkLogTimerHandle(this.window.setTimeout(this.logRemoteInkMinute,1e3*this.logIntervalInSec)))}setLocalInkLogTimerHandle(t){void 0!==this.localInkLogTimerHandle&&this.window.clearTimeout(this.localInkLogTimerHandle),this.localInkLogTimerHandle=t}resetLocalInkCache(){this.lastActivity=void 0,this.lastInputType=void 0}registerEvents(){this.wetCanvas.addEventListener("pointerdown",this.onPointerDown,!0),this.wetCanvas.addEventListener("pointermove",this.onPointerMove,!0),this.wetCanvas.addEventListener("pointerup",this.onPointerUp,!0),this.wetCanvas.addEventListener("beforeunload",this.beforeUnload),this.isEventRegistered=!0}unregisterEvents(){this.wetCanvas.removeEventListener("pointerdown",this.onPointerDown,!0),this.wetCanvas.removeEventListener("pointermove",this.onPointerMove,!0),this.wetCanvas.removeEventListener("pointerup",this.onPointerUp,!0),this.wetCanvas.removeEventListener("beforeunload",this.beforeUnload),this.isEventRegistered=!1}shouldCountPointerMove(t){return this.lastActivity===x.Laser&&this.mouseType===t.pointerType&&this.mouseType===this.lastInputType||!!this.isPointerDown||this.penType===t.pointerType&&this.penType===this.lastInputType}countDistinctSecond(t){const e=Math.floor(Date.now()/1e3);if(e>this.lastInkInSec){if(t===this.remoteInputType)return this.cachedRemoteInkTimeInSec+=1,void(this.lastInkInSec=e);this.lastInputType!==t?(void 0!==this.lastInputType&&this.logLocalInkMinute(),this.lastInputType=t,this.cachedInkTimeInSec=1):this.cachedInkTimeInSec+=1,this.lastInkInSec=e,1===this.cachedInkTimeInSec&&(this.cachedInkStartTime=this.lastInkInSec),this.lastInkInSec-this.cachedInkStartTime>this.logIntervalInSec&&this.logLocalInkMinute()}}countRemoteWetTime(t){this.isPointerDown||(this.countDistinctSecond(this.remoteInputType),t&&this.setRemoteInkLogTimerHandle(this.window.setTimeout(this.logRemoteInkMinute,1e3*this.logIntervalInSec)))}setRemoteInkLogTimerHandle(t){void 0!==this.remoteInkLogTimerHandle&&this.window.clearTimeout(this.remoteInkLogTimerHandle),this.remoteInkLogTimerHandle=t}}function E(){return t="canvas",document.createElement(t);var t}function T(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function M(){return T("g")}function I(){return T("pattern")}function A(){return T("rect")}function C(){return T("svg")}function L(){return T("text")}var O={info:function(){}};function D(t){O=t}var R=function(){function t(){this.settings=void 0}return t.prototype.setSettings=function(e){this.settings=e,t.INSTANCE!==this&&(t.INSTANCE=this)},t.prototype.isChangeGateEnabled=function(t){var e,i,n;return null===(n=null===(i=null===(e=this.settings)||void 0===e?void 0:e.isChangeGateEnabled)||void 0===i?void 0:i.call(e,t))||void 0===n||n},t.prototype.getBooleanAppSetting=function(t){var e,i,n;return null!==(n=null===(i=null===(e=this.settings)||void 0===e?void 0:e.getBooleanAppSetting)||void 0===i?void 0:i.call(e,t))&&void 0!==n&&n},t.prototype.getBooleanFeatureGate=function(t,e){var i,n,s;return null!==(s=null===(n=null===(i=this.settings)||void 0===i?void 0:i.getBooleanFeatureGate)||void 0===n?void 0:n.call(i,t,e))&&void 0!==s?s:e},t.prototype.getIntFeatureGate=function(t,e){var i,n,s;return null!==(s=null===(n=null===(i=this.settings)||void 0===i?void 0:i.getIntFeatureGate)||void 0===n?void 0:n.call(i,t,e))&&void 0!==s?s:e},t.prototype.getStringFeatureGate=function(t,e){var i,n,s;return null!==(s=null===(n=null===(i=this.settings)||void 0===i?void 0:i.getStringFeatureGate)||void 0===n?void 0:n.call(i,t,e))&&void 0!==s?s:e},t.INSTANCE=new t,t}();function N(t,e){t.output=e}function U(t,e,i){N(t,e),N(e,i)}function H(t,e,i,n){N(t,e),U(e,i,n)}const F=.5;function W(t){return{x:t.offsetX,y:t.offsetY,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timeStamp}}function z(t){return{x:t.offsetX,y:t.offsetY,pressure:F,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timeStamp}}class V{onPointerDown(t){this.output.beginStroke(z(t))}onPointerMove(t){this.output.addPoint(z(t))}onPointerUp(t){this.output.endStroke(z(t))}}function X(t){let e=t.offsetX,i=t.offsetY;const n=t.currentTarget;if(null!==n){const s=n.getBoundingClientRect();e=t.clientX-s.left,i=t.clientY-s.top}return{x:e,y:i}}class Y{onPointerDown(t){this.output.beginStroke(function(t){const e=X(t);return{x:e.x,y:e.y,pressure:F,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timeStamp}}(t))}onPointerMove(t){this.output.addPoint(z(t))}onPointerUp(t){this.output.endStroke(z(t))}}class _{onPointerDown(t){this.output.beginStroke(W(t))}onPointerMove(t){this.output.addPoint(W(t))}onPointerUp(t){this.output.endStroke(W(t))}}class B{onPointerDown(t){this.output.beginStroke(function(t){const e=X(t);return{x:e.x,y:e.y,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timeStamp}}(t))}onPointerMove(t){this.output.addPoint(W(t))}onPointerUp(t){this.output.endStroke(W(t))}}function j(t=!1){return r()?t?new Y:new V:t?new B:new _}class ${beginStroke(t){this.lastPoint=t,this.output.beginStroke(t)}addPoint(t){this.lastPoint=t,this.output.addPoint(t)}endStroke(t){this.lastPoint=t,this.output.endStroke(t)}}class G{beginStroke(t){this.output.beginStroke(t),this.point=t}addPoint(t){this.point.x===t.x&&this.point.y===t.y||(this.output.addPoint(t),this.point=t)}endStroke(t){this.output.endStroke(t)}}class K{beginStroke(t){this.out1={x:t.x,y:t.y},this.out2=this.out1,this.output.beginStroke(t)}addPoint(t){this.output.addPoint(this.filter(t))}endStroke(t){this.output.endStroke(this.filter(t))}filter(t){const e={x:q(t.x,this.out1.x,this.out2.x),y:q(t.y,this.out1.y,this.out2.y)};return this.out2=this.out1,this.out1=e,{x:e.x,y:e.y,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}}}function q(t,e,i){return.16999999999999993*t+1.33*e+-.5*i}class J{constructor(){this.lastPressure=F}beginStroke(t){this.output.beginStroke(t),this.lastPressure=t.pressure}addPoint(t){this.output.addPoint(t),this.lastPressure=t.pressure}endStroke(t){this.output.endStroke(0===t.pressure?{x:t.x,y:t.y,pressure:this.lastPressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}:t)}}class Z{constructor(t){this.deduper=new G,this.endStrokePressure=new J,this.jitter=new K,t?(this.preJitterLastPointExtractor=new $,H(this.deduper,this.endStrokePressure,this.preJitterLastPointExtractor,this.jitter)):U(this.deduper,this.endStrokePressure,this.jitter)}beginStroke(t){N(this.jitter,this.output),this.deduper.beginStroke(t)}addPoint(t){this.deduper.addPoint(t)}endStroke(t){this.deduper.endStroke(t)}}function Q(t,e,i,n){const s=(t+e)/2,o=(e+i)/2,r=(i+n)/2,a=(s+o)/2,h=(o+r)/2;return[t,s,a,(a+h)/2,h,r,n]}function tt(t,e,i,n){return[(i-t)/6+e,(e-n)/6+i]}class et{constructor(){this.began=!1}beginStroke(t){this.output.beginStroke(t),this.cp=[t,t,t,t],this.began=!0}addPoint(t){const[e,i]=this.push(t);this.began?this.began=!1:this.output.addSegment(e,i,this.cp[2])}endStroke(t){this.addPoint(t);const[e,i]=this.push(t);this.output.endStroke(e,i,this.cp[2])}push(t){return this.cp.shift(),this.cp.push(t),function(t,e,i,n){const[s,o]=tt(t.x,e.x,i.x,n.x),[r,a]=tt(t.y,e.y,i.y,n.y),[h,u]=it(e.pressure,i.pressure),[c,l]=it(e.tiltX,i.tiltX),[p,d]=it(e.tiltY,i.tiltY),[f,g]=it(e.timestamp,i.timestamp);return[{x:s,y:r,pressure:h,tiltX:c,tiltY:p,timestamp:f},{x:o,y:a,pressure:u,tiltX:l,tiltY:d,timestamp:g}]}(this.cp[0],this.cp[1],this.cp[2],this.cp[3])}}function it(t,e){const i=(e-t)/3;return[t+i,e-i]}class nt{constructor(){this.deduperJitterTransform=new Z(!1),this.fitter=new et,N(this.deduperJitterTransform,this.fitter)}beginStroke(t){N(this.fitter,this.output),this.deduperJitterTransform.beginStroke(t)}addPoint(t){this.deduperJitterTransform.addPoint(t)}endStroke(t){this.deduperJitterTransform.endStroke(t)}}function st(t,e){return{x:t.x+e.x,y:t.y+e.y}}function ot(t,e){return t.x*e.x+t.y*e.y}function rt(t,e){return{x:t.x-e.x,y:t.y-e.y}}function at(t,e){return{x:t.x*e,y:t.y*e}}function ht(t,e){const i=rt(t,e);return ot(i,i)}function ut(t,e,i){const n=Math.sin(i),s=Math.cos(i),o=t.x-e.x,r=t.y-e.y,a=o*n+r*s;return{x:o*s-r*n+e.x,y:a+e.y}}function ct(t,e,i){const n=ht(e,t);if(0===n)return ht(i,t);const s=(i.x-e.x)*(e.y-t.y)-(e.x-t.x)*(i.y-e.y);return s*s/n}class lt{constructor(t){this.flatness=t*t}beginStroke(t){this.output.beginStroke(t),this.beginPoint=t}addSegment(t,e,i){pt(this.beginPoint,t,e,i,this.flatness,this.output),this.output.addPoint(i),this.beginPoint=i}endStroke(t,e,i){pt(this.beginPoint,t,e,i,this.flatness,this.output),this.output.endStroke(i)}}function pt(t,e,i,n,s,o){const[r,a,h,u,c,l,p]=function(t,e,i,n){const[s,o,r,a,h,u,c]=Q(t.x,e.x,i.x,n.x),[l,p,d,f,g,m,v]=Q(t.y,e.y,i.y,n.y),[y,S,w,P,k,x,b]=Q(t.pressure,e.pressure,i.pressure,n.pressure),[E,T,M,I,A,C,L]=Q(t.tiltX,e.tiltX,i.tiltX,n.tiltX),[O,D,R,N,U,H,F]=Q(t.tiltY,e.tiltY,i.tiltY,n.tiltY),[W,z,V,X,Y,_,B]=Q(t.timestamp,e.timestamp,i.timestamp,n.timestamp);return[{x:s,y:l,pressure:y,tiltX:E,tiltY:O,timestamp:W},{x:o,y:p,pressure:S,tiltX:T,tiltY:D,timestamp:z},{x:r,y:d,pressure:w,tiltX:M,tiltY:R,timestamp:V},{x:a,y:f,pressure:P,tiltX:I,tiltY:N,timestamp:X},{x:h,y:g,pressure:k,tiltX:A,tiltY:U,timestamp:Y},{x:u,y:m,pressure:x,tiltX:C,tiltY:H,timestamp:_},{x:c,y:v,pressure:b,tiltX:L,tiltY:F,timestamp:B}]}(t,e,i,n);ct(r,p,u)<=s||(pt(r,a,h,u,s,o),o.addPoint(u),pt(u,c,l,p,s,o))}class dt{constructor(t){this.bezierStrokePath=new nt,this.flattener=new lt(t),N(this.bezierStrokePath,this.flattener)}beginStroke(t){N(this.flattener,this.output),this.bezierStrokePath.beginStroke(t)}addPoint(t){this.bezierStrokePath.addPoint(t)}endStroke(t){this.bezierStrokePath.endStroke(t)}}class ft{constructor(t){this.pointerToStroke=j(),this.strokeSmoothener=new dt(t),N(this.pointerToStroke,this.strokeSmoothener)}onPointerDown(t){N(this.strokeSmoothener,this.output),this.pointerToStroke.onPointerDown(t)}onPointerMove(t){this.pointerToStroke.onPointerMove(t)}onPointerUp(t){this.pointerToStroke.onPointerUp(t)}}class gt{constructor(t){this.pointerToStroke=j(!0),this.strokeSmoothener=new dt(t),N(this.pointerToStroke,this.strokeSmoothener)}onPointerDown(t){N(this.strokeSmoothener,this.output),this.pointerToStroke.onPointerDown(t)}onPointerMove(t){this.pointerToStroke.onPointerMove(t)}onPointerUp(t){this.pointerToStroke.onPointerUp(t)}}function mt(t){return"pen"===t.pointerType}class vt{constructor(){this.transform=t=>t}beginStroke(t){this.output.beginStroke(this.transform(t))}addPoint(t){this.output.addPoint(this.transform(t))}endStroke(t){this.output.endStroke(this.transform(t))}}function yt(t,e=1e-6){return-e<=t&&t<=e}function St(t,e=1e-6){return t<-e||e<t}function wt(t,e,i=1e-6){return yt(t-e,i)}function Pt(t,e,i=1e-6){return St(t-e,i)}function kt(t,e){const i={a:NaN,b:NaN,c:NaN},n=wt(t.x,e.x),s=wt(t.y,e.y);return n&&!s?(i.a=1,i.b=0):!n&&s?(i.a=0,i.b=1):n||s||(i.a=(e.y-t.y)/(t.x-e.x),i.b=1),i.c=-i.a*t.x-i.b*t.y,i}function xt(t,e){return kt(t,ut({x:t.x+1,y:t.y},t,e))}function bt(t){const e=yt(t.a),i=yt(t.b);return e&&!i?[{x:0,y:-t.c/t.b},{x:1,y:-t.c/t.b}]:!e&&i?[{x:-t.c/t.a,y:0},{x:-t.c/t.a,y:1}]:e||i?[]:[{x:0,y:-t.c/t.b},{x:1,y:-t.c/t.b-t.a/t.b}]}function Et(t,e){const i=bt(t);return 2!==i.length?{a:NaN,b:NaN,c:NaN}:kt(st(i[0],e),st(i[1],e))}function Tt(t,e){var i;return null!==(i=Mt(e,{a:-e.b,b:e.a,c:e.b*t.x-e.a*t.y}))&&void 0!==i?i:{x:NaN,y:NaN}}function Mt(t,e){const i=yt(t.b)?e:t,n=yt(t.b)?t:e;if(yt(i.b))return;if(wt(i.a/i.b,n.a/n.b))return;const s=(n.b*i.c-n.c*i.b)/(n.a*i.b-n.b*i.a),o=(-i.c-i.a*s)/i.b;return isFinite(s)&&isFinite(o)?{x:s,y:o}:void 0}function It(t){return 1.5*t+.25}class At{constructor(t,e,i,n){this.snapTopEdgeUnitVector={x:0,y:-1},this.isActivated=!1,this.reset(t,e,i,n)}reset(t,e,i,n){this.centerLine=xt(t,e),this.snapTopEdgeUnitVector=ut({x:0,y:-1},{x:0,y:0},e),this.halfWidth=i,this.snapWidth=n}activate(){this.isActivated=!0}deactivate(){this.isActivated=!1}getCenterLine(){return this.centerLine}getSnapTopEdgeUnitVector(){return this.snapTopEdgeUnitVector}rotate(t,e){this.centerLine=function(t,e,i){const n=bt(t);return 2!==n.length?{a:NaN,b:NaN,c:NaN}:kt(ut(n[0],e,i),ut(n[1],e,i))}(this.centerLine,t,e),this.snapTopEdgeUnitVector=ut(this.snapTopEdgeUnitVector,{x:0,y:0},e)}translate(t){this.centerLine=Et(this.centerLine,t)}isUnderRuler(t,e,i){if(!this.isActivated)return!1;const n=void 0!==i?this.getPointerAttributesOffset(i,e):0;return function(t,e){return Math.abs(e.a*t.x+e.b*t.y+e.c)/Math.sqrt(e.a*e.a+e.b*e.b)}(t,this.centerLine)-n<=this.halfWidth}getSnapEdge(t,e=!0){if(!this.isActivated)return{edge:0,centerProjection:{x:0,y:0},centerDistance:0,snapUnitVector:{x:0,y:0}};let i=0,n={x:0,y:0};const s=Tt(t,this.centerLine),o=rt(t,s),r=Math.sqrt(o.x*o.x+o.y*o.y);return(!e||r<=this.halfWidth+this.snapWidth)&&(n=at(o,1/r),i=ot(this.snapTopEdgeUnitVector,n)>=0?1:2),{edge:i,centerProjection:s,centerDistance:r,snapUnitVector:n}}snapToEdge(t,e,i,n){if(0===i)return t;const s=1===i?this.snapTopEdgeUnitVector:at(this.snapTopEdgeUnitVector,-1);return st(Tt(t,this.centerLine),at(s,this.halfWidth+this.getPointerAttributesOffset(n,e)))}intersectEdge(t,e,i,n,s){if(!this.isActivated)return;const o=this.getSnapEdge(t,!1),r=at(o.snapUnitVector,this.halfWidth),a=Mt(Et(this.centerLine,r),kt(t,i));if(void 0===a)return;const h=rt(t,a),u=Math.sqrt(h.x*h.x+h.y*h.y);if(0===u)return;const c=e+(n-e)*u/Math.sqrt(ht(t,i)),l=(o.centerDistance-this.halfWidth)/u;return st(a,at(h,this.getPointerAttributesOffset(s,c)/(l*u)))}getPointerAttributesOffset(t,e){let i=0;if("ellipse"===t.tip)i=t.width;else if(0!==this.centerLine.a&&0===this.centerLine.b)i=t.width;else if(0===this.centerLine.a&&0!==this.centerLine.b)i=t.height;else{const e=Math.atan(Math.abs(this.centerLine.a/this.centerLine.b));i=(t.height+t.width*Math.tan(e))*Math.cos(e)}return i=It(e)*i,i/2}}class Ct{constructor(t,e){this.scaleFactor={x:1,y:1},this.rulerStrokePathSink=e,this.inputToStroke=t,U(this.inputToStroke,this.scaleTransform(),e)}onPointerDown(t){N(this.rulerStrokePathSink,this.output),this.rulerStrokePathSink.setOverridePointPressureToDefaultWithSnap(mt(t)),this.inputToStroke.onPointerDown(t)}onPointerMove(t){this.inputToStroke.onPointerMove(t)}onPointerUp(t){this.inputToStroke.onPointerUp(t)}setScale(t){t.x<=0||t.y<=0||(this.scaleFactor=t)}scaleTransform(){const t=new vt;return t.transform=t=>({x:t.x*this.scaleFactor.x,y:t.y*this.scaleFactor.y,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}),t}}const Lt=new At({x:0,y:0},0,0,0);class Ot{constructor(t,e,i){this.snapRulerEdge=0,this.prevPoint=void 0,this.strokeStatus=0,this.overridePointPressureToDefaultWithSnap=!1,this.rulerModel=t,this.pointerAttributes=e,this.primaryRulerSink=i}getSnapRulerEdge(){return this.snapRulerEdge}setOverridePointPressureToDefaultWithSnap(t){this.overridePointPressureToDefaultWithSnap=t}beginStroke(t){(void 0===this.primaryRulerSink||0===this.primaryRulerSink.getSnapRulerEdge())&&this.rulerProxy().isUnderRuler({x:t.x,y:t.y},t.pressure)||(this.strokeStatus=1,void 0===this.primaryRulerSink?this.snapRulerEdge=this.rulerProxy().getSnapEdge({x:t.x,y:t.y}).edge:this.snapRulerEdge=this.primaryRulerSink.getSnapRulerEdge(),this.output.beginStroke(this.snapToEdge(t)),this.prevPoint=t)}addPoint(t){this.processIncomingPoint(t,!1)}endStroke(t){this.processIncomingPoint(t,!0)}processIncomingPoint(t,e){if(0===this.strokeStatus)return;let i=!1;if(0===this.snapRulerEdge){const e=this.rulerProxy().isUnderRuler({x:t.x,y:t.y},t.pressure,this.pointerAttributes());1===this.strokeStatus&&e?(this.output.endStroke(this.snapToIntersection(t,this.prevPoint,!0)),this.strokeStatus=void 0===this.primaryRulerSink?2:0,i=!0):2!==this.strokeStatus||e||(this.strokeStatus=1,this.output.beginStroke(this.snapToIntersection(t,this.prevPoint,!1)))}if(!i&&1===this.strokeStatus){const i=this.snapToEdge(t);e?this.output.endStroke(i):this.output.addPoint(i)}this.prevPoint=t}rulerProxy(){const t=this.rulerModel();return void 0!==t?t:Lt}snapToIntersection(t,e,i){if(void 0===e)return t;const n=i?{x:e.x,y:e.y}:{x:t.x,y:t.y},s=i?e.pressure:t.pressure,o=i?{x:t.x,y:t.y}:{x:e.x,y:e.y},r=i?t.pressure:e.pressure,a=this.rulerProxy().intersectEdge(n,s,o,r,this.pointerAttributes());return void 0===a?t:{x:a.x,y:a.y,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}}snapToEdge(t){if(0===this.snapRulerEdge)return t;const e=this.overridePointPressureToDefaultWithSnap?F:t.pressure,i=this.rulerProxy().snapToEdge({x:t.x,y:t.y},e,this.snapRulerEdge,this.pointerAttributes());return{x:i.x,y:i.y,pressure:e,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}}}class Dt{constructor(t){this.element=t}onPointerOver(t){mt(t)&&u(this.element)}onPointerOut(t){mt(t)&&c(this.element)}}class Rt{constructor(t){this.hapticsExtractor=new p,this.waveform=t}set output(t){N(this.hapticsExtractor,t)}onPointerDown(t){this.hapticsExtractor.onPointerDown(t),this.hapticsExtractor.play(this.waveform)}onPointerMove(t){this.hapticsExtractor.onPointerMove(t)}onPointerUp(t){this.hapticsExtractor.onPointerUp(t),this.hapticsExtractor.stop()}}class Nt{constructor(t){this.onPointerDown=t=>{this.output.onPointerDown(t)},this.onTouchStart=t=>{this.output.onTouchStart(t)},this.element=t}activate(){this.element.addEventListener("pointerdown",this.onPointerDown,!0),this.element.addEventListener("touchstart",this.onTouchStart,!0)}deactivate(){this.element.removeEventListener("pointerdown",this.onPointerDown,!0),this.element.removeEventListener("touchstart",this.onTouchStart,!0)}}class Ut{constructor(t){this.onPointerDown=t=>{this.output.onPointerDown(t)},this.onPointerUp=t=>{this.output.onPointerUp(t)},this.onPointerOver=t=>{this.output.onPointerOver(t)},this.onTouchStart=t=>{this.output.onTouchStart(t)},this.element=t}activate(){this.element.addEventListener("pointerdown",this.onPointerDown),this.element.addEventListener("pointerup",this.onPointerUp),this.element.addEventListener("pointerover",this.onPointerOver),this.element.addEventListener("touchstart",this.onTouchStart)}deactivate(){this.element.removeEventListener("pointerdown",this.onPointerDown),this.element.removeEventListener("pointerup",this.onPointerUp),this.element.removeEventListener("pointerover",this.onPointerOver),this.element.removeEventListener("touchstart",this.onTouchStart)}}class Ht{constructor(t){this.onPointerOver=t=>{this.output.onPointerOver(t)},this.onPointerOut=t=>{this.output.onPointerOut(t)},this.element=t}activate(){this.element.addEventListener("pointerover",this.onPointerOver),this.element.addEventListener("pointerout",this.onPointerOut)}deactivate(){this.element.removeEventListener("pointerover",this.onPointerOver),this.element.removeEventListener("pointerout",this.onPointerOut)}}function Ft(t){return 2===t.button||2==(2&t.buttons)}function Wt(t){return 5===t.button||32==(32&t.buttons)}class zt{constructor(){this.active=!1}onMouseDown(t){this.output.onMouseDown(t),this.active=!0}onMouseMove(t){this.active&&this.output.onMouseMove(t)}onMouseUp(t){this.active=!1,this.output.onMouseUp(t)}}class Vt{constructor(t){this.onMouseDown=t=>{this.output.onMouseDown(t)},this.onMouseMove=t=>{this.output.onMouseMove(t)},this.onMouseUp=t=>{this.output.onMouseUp(t)},this.element=t}activate(){this.element.addEventListener("mousedown",this.onMouseDown),this.element.addEventListener("mousemove",this.onMouseMove),this.element.addEventListener("mouseup",this.onMouseUp)}deactivate(){this.element.removeEventListener("mousedown",this.onMouseDown),this.element.removeEventListener("mousemove",this.onMouseMove),this.element.removeEventListener("mouseup",this.onMouseUp)}}function Xt(t){t.preventDefault()}function Yt(t){t.preventDefault(),t.stopPropagation()}class _t{onMouseDown(t){this.output.onMouseDown(t),Yt(t)}onMouseMove(t){this.output.onMouseMove(t),Yt(t)}onMouseUp(t){this.output.onMouseUp(t),Yt(t)}}class Bt{constructor(t){U(this.head=new Vt(t),new _t,this.tail=new zt)}set output(t){this.tail.output=t}activate(){this.head.activate()}deactivate(){this.head.deactivate()}}function jt(t){return{offsetX:t.offsetX,offsetY:t.offsetY,pressure:.5,tiltX:0,tiltY:0,timeStamp:t.timeStamp,pointerType:"mouse"}}class $t{onMouseDown(t){this.output.onPointerDown(jt(t))}onMouseMove(t){this.output.onPointerMove(jt(t))}onMouseUp(t){this.output.onPointerUp(jt(t))}}class Gt{constructor(t,e,i){this.normalOutput=t,this.tailOutput=e,this.barrelOutput=i,this.output=t}onPointerDown(t){mt(t)?Wt(t)?this.output=this.tailOutput:Ft(t)?this.output=this.barrelOutput:this.output=this.normalOutput:this.output=this.normalOutput,this.output.onPointerDown(t)}onPointerMove(t){this.output.onPointerMove(t)}onPointerUp(t){this.output.onPointerUp(t)}}class Kt{constructor(){this.activePointerId=-1}onPointerDown(t){-1===this.activePointerId&&(this.activePointerId=t.pointerId,this.output.onPointerDown(t))}onPointerMove(t){this.activePointerId===t.pointerId&&this.output.onPointerMove(t)}onPointerUp(t){this.activePointerId===t.pointerId&&(this.output.onPointerUp(t),this.activePointerId=-1)}}class qt{constructor(t){this.element=t}onPointerDown(t){try{this.element.setPointerCapture(t.pointerId)}finally{this.output.onPointerDown(t)}}onPointerMove(t){this.output.onPointerMove(t)}onPointerUp(t){this.output.onPointerUp(t)}}class Jt{onPointerDown(t){this.output.onPointerDown(t)}onPointerMove(t){(function(t){if("getCoalescedEvents"in t){const e=t.getCoalescedEvents();if(e.length>=1)return e}return[t]})(t).forEach((t=>{this.output.onPointerMove(t)}))}onPointerUp(t){this.output.onPointerUp(t)}}class Zt{constructor(t){this.onPointerDown=t=>{this.output.onPointerDown(t)},this.onPointerMove=t=>{this.output.onPointerMove(t)},this.onPointerUp=t=>{this.output.onPointerUp(t)},this.element=t}activate(){this.element.addEventListener("pointerdown",this.onPointerDown),this.element.addEventListener("pointermove",this.onPointerMove),this.element.addEventListener("pointerup",this.onPointerUp)}deactivate(){this.element.removeEventListener("pointerdown",this.onPointerDown),this.element.removeEventListener("pointermove",this.onPointerMove),this.element.removeEventListener("pointerup",this.onPointerUp)}}class Qt{constructor(t){this.element=t}activate(){this.element.addEventListener("touchmove",Xt)}deactivate(){this.element.removeEventListener("touchmove",Xt)}}class te{onPointerDown(t){this.output.onPointerDown(t),Yt(t)}onPointerMove(t){this.output.onPointerMove(t),Yt(t)}onPointerUp(t){this.output.onPointerUp(t),Yt(t)}}class ee{constructor(t){var e,i,n,s,o;e=this.head=new Zt(t),i=new qt(t),n=new te,s=new Kt,o=this.tail=new Jt,U(e,i,n),U(n,s,o),a()&&(this.preventDefaultOnTouchMove=new Qt(t))}set output(t){this.tail.output=t}activate(){var t;this.head.activate(),null===(t=this.preventDefaultOnTouchMove)||void 0===t||t.activate()}deactivate(){var t;this.head.deactivate(),null===(t=this.preventDefaultOnTouchMove)||void 0===t||t.deactivate()}}class ie{constructor(){this.wasPenDown=!1}onPointerDown(t){this.wasPenDown=mt(t)}onTouchStart(t){this.wasPenDown&&Yt(t)}}class ne{constructor(){this.activeIdentifier=-1}onTouchStart(t,e){-1===this.activeIdentifier&&(this.activeIdentifier=e.identifier,this.output.onTouchStart(t,e))}onTouchMove(t,e){this.activeIdentifier===e.identifier&&this.output.onTouchMove(t,e)}onTouchEnd(t,e){this.activeIdentifier===e.identifier&&(this.output.onTouchEnd(t,e),this.activeIdentifier=-1)}}class se{onTouchStart(t){for(let e=0;e<t.changedTouches.length;e+=1)this.output.onTouchStart(t,t.changedTouches[e])}onTouchMove(t){for(let e=0;e<t.changedTouches.length;e+=1)this.output.onTouchMove(t,t.changedTouches[e])}onTouchEnd(t){for(let e=0;e<t.changedTouches.length;e+=1)this.output.onTouchEnd(t,t.changedTouches[e])}}class oe{constructor(t){this.onTouchStart=t=>{this.output.onTouchStart(t)},this.onTouchMove=t=>{this.output.onTouchMove(t)},this.onTouchEnd=t=>{this.output.onTouchEnd(t)},this.element=t}activate(){this.element.addEventListener("touchstart",this.onTouchStart),this.element.addEventListener("touchmove",this.onTouchMove),this.element.addEventListener("touchend",this.onTouchEnd)}deactivate(){this.element.removeEventListener("touchstart",this.onTouchStart),this.element.removeEventListener("touchmove",this.onTouchMove),this.element.removeEventListener("touchend",this.onTouchEnd)}}class re{onTouchStart(t){this.output.onTouchStart(t),Yt(t)}onTouchMove(t){this.output.onTouchMove(t),Yt(t)}onTouchEnd(t){this.output.onTouchEnd(t),Yt(t)}}class ae{constructor(t){H(this.head=new oe(t),new re,new se,this.tail=new ne)}set output(t){this.tail.output=t}activate(){this.head.activate()}deactivate(){this.head.deactivate()}}function he(t){return 180*t/Math.PI}function ue(t,e){const i=e.target.getBoundingClientRect(),n=function(t){const e={x:0,y:0};if("azimuthAngle"in t&&"altitudeAngle"in t){const i=t.azimuthAngle,n=t.altitudeAngle;e.x=he(Math.atan2(Math.cos(i),Math.tan(n))),e.y=he(Math.atan2(Math.sin(i),Math.tan(n)))}return e}(e);return{offsetX:e.clientX-i.left,offsetY:e.clientY-i.top,pressure:e.force,tiltX:n.x,tiltY:n.y,timeStamp:t.timeStamp,pointerType:"touch"}}class ce{onTouchStart(t,e){this.output.onPointerDown(ue(t,e))}onTouchMove(t,e){this.output.onPointerMove(ue(t,e))}onTouchEnd(t,e){this.output.onPointerUp(ue(t,e))}}class le{constructor(){this.offsetX=0,this.offsetY=0}setDrawingAttributes(t){this.output.setDrawingAttributes(1===t.effect.type?new w(t).setEffect({type:1,pattern:t.effect.pattern,offsetX:this.offsetX,offsetY:this.offsetY}).build():t)}beginStroke(t){this.output.beginStroke(t),this.begin=t}addPoint(t){this.output.addPoint(t)}endStroke(t){this.output.endStroke(t);const e=t.x-this.begin.x,i=t.y-this.begin.y,n=e>0?48:-48;this.offsetX+=e+n,this.offsetY+=i+n,this.offsetX%=540,this.offsetY%=540}}class pe{constructor(t=y){this.offset=new le,this.setDrawingAttributes(t)}setDrawingAttributes(t){this.attributes=t}getDrawingAttributes(){return this.attributes}beginStroke(t){N(this.offset,this.output),this.out=1===this.attributes.effect.type?this.offset:this.output,this.out.setDrawingAttributes(this.attributes),this.out.beginStroke(t)}addPoint(t){this.out.addPoint(t)}endStroke(t){this.out.endStroke(t)}}function de(t,e,i){const n=[-e.x,e.x,-e.y,e.y],s=[t.x-i.left,i.right-t.x,t.y-i.top,i.bottom-t.y];let o=0,r=1;for(let t=0;t<4;t+=1)if(0===n[t]){if(s[t]<0)return[10,-10]}else n[t]<0?o=Math.max(o,s[t]/n[t]):r=Math.min(r,s[t]/n[t]);return[o,r]}function fe(t){return t.right-t.left}function ge(t){return t.bottom-t.top}function me(){return{left:Number.MAX_VALUE,right:-Number.MAX_VALUE,top:Number.MAX_VALUE,bottom:-Number.MAX_VALUE}}function ve(t,e){t.left=Math.min(t.left,e.x),t.right=Math.max(t.right,e.x),t.top=Math.min(t.top,e.y),t.bottom=Math.max(t.bottom,e.y)}function ye(t,e){t.left=Math.min(t.left,e.left),t.top=Math.min(t.top,e.top),t.right=Math.max(t.right,e.right),t.bottom=Math.max(t.bottom,e.bottom)}function Se(t,e,i){const[n,s]=de(t,rt(e,t),i);return n<=s}function we(t,e,i,n,s){return Se(t,e,function(t,e,i){return{left:t.left-e,right:t.right+e,top:t.top-i,bottom:t.bottom+i}}(i,n,s))}function Pe(t,e,i,n){const s=e.x-t.x,o=e.y-t.y,r=n.x-i.x,a=n.y-i.y,h=s*a-r*o;if(0===h)return!1;const u=(r*(t.y-i.y)-a*(t.x-i.x))/h,c=(s*(t.y-i.y)-o*(t.x-i.x))/h;return u>=0&&u<=1&&c>=0&&c<=1}function ke(){}function xe(t,e,i){let n,s=!1;const o={add:ke},r=t=>{Pe(n,t,e,i)&&(o.add=ke,s=!0),n=t};return o.add=t=>{o.add=r,n=t},t.streamPoints(o),s}function be(t){return t*Math.PI/180}class Ee{toCSSColor(t){return function(t){return`rgba(${t.r},${t.g},${t.b},${t.a})`}(t)}}var Te,Me,Ie;!function(t){t.Mouse="mouse",t.Pen="pen",t.Touch="touch",t.Keyboard="keyboard"}(Te||(Te={})),function(t){t.ArrowLeft="ArrowLeft",t.ArrowRight="ArrowRight",t.ArrowUp="ArrowUp",t.ArrowDown="ArrowDown"}(Me||(Me={})),function(t){t[t.logMove=0]="logMove",t[t.logRotate=1]="logRotate",t[t.performedManipulation=2]="performedManipulation"}(Ie||(Ie={}));class Ae{constructor(t,e,i){this.isMoving=!1,this.isSnapped=!1,this.rotationTimer=-1,this.logRotate=!1,this.logMove=!1,this.primaryFingerPos={x:0,y:0},this.secondaryFingerPos={x:0,y:0},this.lastMovePos={x:0,y:0},this.primaryId=-1,this.thirdFingerId=-1,this.fingerToLastPosMap=new Map,this.mouseLastPos=void 0,this.penLastPosMap=new Map,this.lastMidpointPos={x:0,y:0},this.useBrowserSpecificTransform=!0,this.fixFirefoxMultitouch=!1,this.onPointerDown=t=>{const e=Ce({x:t.clientX,y:t.clientY},this.eventsElement,this.ruler.getProperties().scale,this.useBrowserSpecificTransform);this.eventsElement.setPointerCapture(t.pointerId),this.onPointerDownImpl(t.isPrimary,t.pointerId,e,t.pointerType),this.preventDefaultAndStopPropagation(t)},this.onPointerMove=t=>{void 0!==this.setCursor&&this.setCursor();const e=Ce({x:t.clientX,y:t.clientY},this.eventsElement,this.ruler.getProperties().scale,this.useBrowserSpecificTransform);this.onPointerMoveImpl(t.pointerId,e,t.isPrimary,t.pointerType),this.preventDefaultAndStopPropagation(t)},this.onPointerUp=t=>{if(this.removePointerFromMap(t.pointerType,t.pointerId),this.isRulerInUse()||this.ruler.setOpacity(this.ruler.getSettings().opacityUntouched),t.pointerId===this.primaryId&&this.fingerToLastPosMap.size>0){for(const t of Array.from(this.fingerToLastPosMap.keys()))if(1!==t){this.primaryId=t;break}this.primaryFingerPos=this.secondaryFingerPos}this.isMoving=this.isRulerInUse(),this.isMoving||(this.logRulerActivity(t.pointerType),this.logRotate=!1,this.logMove=!1),this.preventDefaultAndStopPropagation(t)},this.onWheel=t=>{0!==t.deltaY&&(function(t,e,i){const n=i.getProperties(),s=st(n.compassOffset,n.position);i.rotate(t);const o=ut(s,e,be(t));i.move(o.x-s.x,o.y-s.y)}(t.deltaY>0?1:-1,this.lastMovePos,this.ruler),Yt(t),clearTimeout(this.wheelLoggerTask),this.logRotate=!0,this.wheelLoggerTask=this.window.setTimeout((()=>{this.logRulerActivity(Te.Mouse),this.logRotate=!1}),1e3))},this.onKeyDown=t=>{const e=function(t,e){let i=!1,n=!1;switch(t.key){case Me.ArrowLeft:return t.altKey&&t.shiftKey?(n=!0,e.rotate(-1)):t.altKey?(n=!0,e.rotate(-15)):(i=!0,e.move(-1,0)),[i,n,!0];case Me.ArrowRight:return t.altKey&&t.shiftKey?(n=!0,e.rotate(1)):t.altKey?(n=!0,e.rotate(15)):(i=!0,e.move(1,0)),[i,n,!0];case Me.ArrowUp:return e.move(0,-1),[!0,n,!0];case Me.ArrowDown:return e.move(0,1),[!0,n,!0];default:return[i,n,!1]}}(t,this.ruler);this.logMove=!!e[Ie.logMove]||this.logMove,this.logRotate=!!e[Ie.logRotate]||this.logRotate,clearTimeout(this.keyboardEventLoggerTask),this.keyboardEventLoggerTask=this.window.setTimeout((()=>{this.logRulerActivity(Te.Keyboard),this.logMove=!1,this.logRotate=!1}),1e3),e[Ie.performedManipulation]&&Yt(t)},this.ruler=t,this.eventsElement=this.ruler.getPointerEventsElement(),this.setCursor=e,this.window=null!=i?i:window}activate(){this.eventsElement.addEventListener("pointerdown",this.onPointerDown),this.eventsElement.addEventListener("pointermove",this.onPointerMove),this.eventsElement.addEventListener("pointerup",this.onPointerUp),this.eventsElement.addEventListener("wheel",this.onWheel),this.eventsElement.addEventListener("keydown",this.onKeyDown),this.ruler.setVisibility(!0)}deactivate(){this.ruler.setVisibility(!1),this.eventsElement.removeEventListener("pointerdown",this.onPointerDown),this.eventsElement.removeEventListener("pointermove",this.onPointerMove),this.eventsElement.removeEventListener("pointerup",this.onPointerUp),this.eventsElement.removeEventListener("wheel",this.onWheel),this.eventsElement.removeEventListener("keydown",this.onKeyDown)}resetManipulationState(){this.fingerToLastPosMap.clear(),this.penLastPosMap.clear(),this.mouseLastPos=void 0,this.isMoving=!1,this.primaryId=-1,this.logRotate=!1,this.logMove=!1}setLogger(t){this.rulerLogger=t}setUseBrowserSpecificTransform(t){this.useBrowserSpecificTransform=t}setFixFirefoxMultitouch(t){this.fixFirefoxMultitouch=t}onPointerDownImpl(t,e,i,n){this.ruler.setOpacity(this.ruler.getSettings().opacityTouched),this.lastMovePos=i,this.updateLastPosition(n,e,i,t,!0),this.fingerToLastPosMap.size>1&&(this.rotationTimer=Date.now(),2===this.fingerToLastPosMap.size&&(this.lastMidpointPos=at(st(this.primaryFingerPos,this.secondaryFingerPos),.5),this.ruler.setCompassPosition(this.lastMidpointPos))),this.isMoving=!0}onPointerMoveImpl(t,e,i,n){const s=this.getLastPosition(n,t);if(this.isMoving&&s)if(n!==Te.Touch&&0===this.fingerToLastPosMap.size||n===Te.Touch&&1===this.fingerToLastPosMap.size)this.ruler.move(e.x-s.x,e.y-s.y),this.logMove=!0;else if(this.fingerToLastPosMap.size>=2&&n===Te.Touch&&t!==this.thirdFingerId){const i=t===this.primaryId?this.secondaryFingerPos:this.primaryFingerPos,n=at(st(e,i),.5);this.ruler.move(n.x-this.lastMidpointPos.x,n.y-this.lastMidpointPos.y),this.logMove=!0,this.lastMidpointPos=n;const s=function(t,e){const i=ht(t,{x:0,y:0});return ht(e,{x:0,y:0})>i?he(Math.atan2(e.y-t.y,e.x-t.x)):he(Math.atan2(t.y-e.y,t.x-e.x))}(e,i),o=Date.now()-this.rotationTimer;o>10&&this.multiTouchRotate(s,o)}this.lastMovePos=e,this.updateLastPosition(n,t,e,i)}logRulerActivity(t){void 0!==this.rulerLogger&&this.rulerLogger.logActivity(t,this.logMove,this.logRotate,this.ruler.getProperties().rotation,this.isSnapped)}updateLastPosition(t,e,i,n,s=!1){t!==Te.Mouse||!s&&void 0===this.mouseLastPos?t===Te.Pen?(n&&s&&(this.penLastPosMap.clear(),this.penLastPosMap.set(e,i)),(s||void 0!==this.penLastPosMap.get(e))&&this.penLastPosMap.set(e,i)):t===Te.Touch&&(void 0===this.fingerToLastPosMap.get(e)&&n&&(this.fingerToLastPosMap.clear(),this.primaryId=e),2===this.fingerToLastPosMap.size&&void 0===this.fingerToLastPosMap.get(e)&&(this.thirdFingerId=e),this.fingerToLastPosMap.set(e,i),this.primaryId===e?this.primaryFingerPos=this.lastMovePos:(e!==this.thirdFingerId||this.fingerToLastPosMap.size<3)&&(this.secondaryFingerPos=this.lastMovePos)):this.mouseLastPos=i}isRulerInUse(){return void 0!==this.mouseLastPos||this.penLastPosMap.size>0||this.fingerToLastPosMap.size>0}getLastPosition(t,e){return t===Te.Mouse?this.mouseLastPos:t===Te.Pen?this.penLastPosMap.get(e):t===Te.Touch?this.fingerToLastPosMap.get(e):void 0}removePointerFromMap(t,e){t===Te.Mouse?this.mouseLastPos=void 0:t===Te.Pen?this.penLastPosMap.delete(e):t===Te.Touch&&this.fingerToLastPosMap.delete(e)}multiTouchRotate(t,e){const i=this.ruler.getProperties().rotation,n=3===this.fingerToLastPosMap.size?5:45;let s=(t-i)%180;const o=s/e,r=Math.min(Math.abs(t%n),n-Math.abs(t%n));r<5&&(Math.abs(o)>.03||this.isSnapped||3===this.fingerToLastPosMap.size)?(this.isSnapped=!0,s=Math.round(t/n)*n-i):r>=5&&(this.isSnapped=!1),this.ruler.rotate(s),this.rotationTimer=Date.now(),this.logRotate=!0}preventDefaultAndStopPropagation(t){r()&&this.fixFirefoxMultitouch||Xt(t),function(t){t.stopPropagation()}(t)}}function Ce(t,e,i,n){var s;const o=e.createSVGPoint();o.x=t.x,o.y=t.y;const h=o.matrixTransform(null===(s=e.getScreenCTM())||void 0===s?void 0:s.inverse());if(n){if(function(){const t=-1!==navigator.userAgent.indexOf("Chrome");return-1!==navigator.userAgent.indexOf("Safari")&&!t}()||a())return{x:h.x/i,y:h.y/i};if(r()){const t=new DOMMatrix(e.style.transform);return{x:h.x/i+t.e,y:h.y/i+t.f}}}return{x:h.x,y:h.y}}class Le{constructor(){this.size={w:0,h:0},this.position={x:0,y:0},this.compassOffset={x:0,y:0},this.rotation=0,this.opacity=0,this.visible=!1,this.viewSize={w:0,h:0},this.scale=0}}const Oe=60;class De{constructor(t,e,i,n){var s,o,r,a;this.internalSize={w:0,h:0},this.currentScale=0,this.rulerAnchor=C(),this.rotationElement=M(),this.rulerElement=C(),this.rulerBodyElement=A(),this.rulerTopTicksElement=A(),this.rulerBottomTicksElement=A(),this.angleIndicatorElement=C(),this.indicatorTicksElement=C(),this.defsElement=T("defs"),this.patternElement=I(),this.compassElement=C(),this.radialTicksElement=C(),this.angleTextElement=C(),this.angleText=L(),this.colorResolver=i,this.a11yLabelWithDegreesPlaceholder=n,this.initRuler(t,e),s=this.rulerBodyElement,o=this.rulerElement,r=e.settings.borderThickness,a={w:e.properties.size.w,h:e.settings.height},He(s,{x:r,y:r}),Fe(s,a),s.setAttribute("stroke-width",`${r}`),o.appendChild(s),Re(this.rulerTopTicksElement,this.rulerElement,e.settings.borderThickness,e.properties.size.w,!1),Re(this.rulerBottomTicksElement,this.rulerElement,e.settings.borderThickness,e.properties.size.w,!0),this.initCompass(e),this.initAngleIndicator(e),this.updateTickMarkPatternElement(e.properties.scale,e.theme.tickMarkColor,e.settings.tickMarkThickness),this.updateThemeColors(e.theme)}setVisibility(t){this.rulerAnchor.setAttribute("visibility",t?"visible":"hidden")}setOpacity(t){this.rulerAnchor.setAttribute("fill-opacity",`${t}`)}setPosition(t){Ne(this.rulerAnchor,t)}setRotation(t){this.updateAngleText(t),this.rotationElement.setAttribute("transform",`rotate(${t} 0 0)`)}setCompassPosition(t){Ne(this.compassElement,t)}setAngleIndicatorPosition(t){Ne(this.angleIndicatorElement,t)}themeChanged(t){this.updateThemeColors(t)}setAriaLabel(t){this.a11yLabelWithDegreesPlaceholder=t,null!==this.angleText.textContent&&this.updateAriaLabel(this.angleText.textContent)}setAriaDescription(t){this.rulerElement.setAttribute("aria-description",t)}scaleChanged(t){this.currentScale<=1&&t.properties.scale<=1?this.currentScale=t.properties.scale:this.updateTickMarkPatternElement(t.properties.scale,t.theme.tickMarkColor,t.settings.tickMarkThickness)}viewSizeChanged(t){this.updateInternalSize(t),Ne(this.rulerElement,{x:-this.internalSize.w/2,y:-this.internalSize.h/2}),Ue(this.rulerElement,this.internalSize),Fe(this.rulerBodyElement,{w:t.properties.size.w,h:t.settings.height});const e=t.settings.borderThickness;Fe(this.rulerTopTicksElement,{w:t.properties.size.w,h:20-e}),Fe(this.rulerBottomTicksElement,{w:t.properties.size.w,h:20-e})}getInternalSize(){return this.internalSize}updateInternalSize(t){this.internalSize={w:t.properties.size.w+2*t.settings.borderThickness,h:t.properties.size.h+2*t.settings.borderThickness}}initRuler(t,e){var i,n,s;this.updateInternalSize(e),i=this.rulerAnchor,n=e.properties.position,s=e.settings.opacityUntouched,Ne(i,n),Ue(i,{w:1,h:1}),i.setAttribute("transform-origin","center"),i.setAttribute("overflow","visible"),i.setAttribute("fill-opacity",`${s}`),t.appendChild(this.rulerAnchor),this.setRotation(e.properties.rotation),this.rulerAnchor.appendChild(this.rotationElement),function(t,e){Ne(t,{x:-e.w/2,y:-e.h/2}),Ue(t,e),t.setAttribute("touch-action","auto"),t.setAttribute("pointer-events","auto"),t.setAttribute("tabindex","0"),t.setAttribute("id","inkRuler")}(this.rulerElement,this.internalSize),this.defsElement.appendChild(this.patternElement),this.rulerElement.appendChild(this.defsElement),this.rotationElement.appendChild(this.rulerElement)}initCompass(t){var e;Ne(e=this.compassElement,t.properties.compassOffset),Ue(e,{w:1,h:1}),e.setAttribute("overflow","visible"),this.rulerAnchor.appendChild(this.compassElement);const i=t.settings.compassDiameter,n=i/2;!function(t,e,i,n){Ne(t,{x:-i,y:-i}),Ue(t,{w:e,h:e}),t.setAttribute("stroke-width",`${n}`)}(this.radialTicksElement,i,n,t.settings.borderThickness),function(t,e){const i=e,n=e;for(let s=0;s<360;s+=10){const o=be(s),r=e-(s%90==0?12:8),a={x:i+r*Math.cos(o),y:n+r*Math.sin(o)},h={x:i+e*Math.cos(o),y:n+e*Math.sin(o)};t.appendChild(ze(a,h))}}(this.radialTicksElement,n),this.compassElement.appendChild(this.radialTicksElement),this.initAngleText(t.properties.rotation)}initAngleText(t){var e;(e=this.angleTextElement).setAttribute("font-family","Segoe UI Light, Helvetica Neue, sans serif"),e.setAttribute("font-size","18"),e.setAttribute("dominant-baseline","middle"),e.setAttribute("text-anchor","middle"),this.radialTicksElement.appendChild(this.angleTextElement),We(this.angleText,"50%","50%"),this.updateAngleText(t),this.angleTextElement.appendChild(this.angleText);const i=L();We(i,"68%","44%"),i.textContent="°",this.angleTextElement.appendChild(i)}updateAngleText(t){this.angleText.textContent=`${function(t){let e=Math.abs(Math.round(t)+180)%180;return e>90&&(e=180-e),e}(t)}`,this.updateAriaLabel(this.angleText.textContent)}updateAriaLabel(t){this.rulerElement.setAttribute("aria-label",this.a11yLabelWithDegreesPlaceholder.replace("{{param0}}",t))}initAngleIndicator(t){const e=t.settings.compassDiameter,i=e/2;var n;Ne(n=this.angleIndicatorElement,{x:this.internalSize.w/2+t.properties.compassOffset.x,y:this.internalSize.h/2+t.properties.compassOffset.y}),Ue(n,{w:1,h:1}),n.setAttribute("overflow","visible"),this.rulerElement.appendChild(this.angleIndicatorElement),function(t,e,i,n){Ne(t,{x:-i,y:-i}),Ue(t,{w:e,h:e}),t.setAttribute("stroke-width",`${n}`)}(this.indicatorTicksElement,e,i,t.settings.angleIndicatorThickness),function(t,e,i){t.appendChild(ze({x:0,y:i},{x:12,y:i})),t.appendChild(ze({x:e-12,y:i},{x:e,y:i}))}(this.indicatorTicksElement,e,i),this.angleIndicatorElement.appendChild(this.indicatorTicksElement)}updateTickMarkPatternElement(t,e,i){const n=Math.max(1,t),s=this.patternElement;var o,r;this.patternElement=I(),o=this.patternElement,r={w:Oe*n,h:20},o.setAttribute("id","tick-marks"),o.setAttribute("x","0"),o.setAttribute("y","0"),o.setAttribute("width",`${r.w}`),o.setAttribute("height",`${r.h}`),o.setAttribute("patternUnits","userSpaceOnUse"),this.ticksGroupElement=M(),function(t,e,i){t.setAttribute("stroke",e),t.setAttribute("stroke-width",`${i}`),t.setAttribute("stroke-linecap","butt")}(this.ticksGroupElement,this.colorResolver.toCSSColor(e),i),function(t,e){const i=6*t,n={x:1,y:1};for(let t=0;t<10;t++)0===t?e.appendChild(ze(n,{x:n.x,y:20})):5===t?e.appendChild(ze(n,{x:n.x,y:16})):e.appendChild(ze(n,{x:n.x,y:12})),n.x+=i}(n,this.ticksGroupElement),this.patternElement.appendChild(this.ticksGroupElement),this.defsElement.removeChild(s),this.defsElement.appendChild(this.patternElement),this.currentScale=t}updateThemeColors(t){this.rulerBodyElement.setAttribute("fill",this.colorResolver.toCSSColor(t.backgroundColor)),this.rulerBodyElement.setAttribute("stroke",this.colorResolver.toCSSColor(t.borderColor)),this.radialTicksElement.setAttribute("stroke",this.colorResolver.toCSSColor(t.borderColor)),this.angleTextElement.setAttribute("stroke",this.colorResolver.toCSSColor(t.angleTextColor)),this.ticksGroupElement.setAttribute("stroke",this.colorResolver.toCSSColor(t.tickMarkColor)),this.indicatorTicksElement.setAttribute("stroke",this.colorResolver.toCSSColor(t.angleIndicatorColor))}}function Re(t,e,i,n,s){He(t,{x:i,y:i}),Fe(t,{w:n,h:20-i}),t.setAttribute("fill","url(#tick-marks)"),s&&(t.setAttribute("transform","scale(1,-1)"),t.setAttribute("transform-origin","center")),e.appendChild(t)}function Ne(t,e){t.setAttribute("x",`${Ve(e.x)}`),t.setAttribute("y",`${Ve(e.y)}`)}function Ue(t,e){t.setAttribute("width",`${e.w}`),t.setAttribute("height",`${e.h}`)}function He(t,e){t.setAttribute("x",`${Ve(e.x)}`),t.setAttribute("y",`${Ve(e.y)}`)}function Fe(t,e){t.setAttribute("width",`${e.w}`),t.setAttribute("height",`${e.h}`)}function We(t,e,i){t.setAttribute("x",e),t.setAttribute("y",i),t.setAttribute("style","-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none"),t.setAttribute("alignment-baseline","middle")}function ze(t,e){const i=T("line");return i.setAttribute("x1",`${Ve(t.x)}`),i.setAttribute("y1",`${Ve(t.y)}`),i.setAttribute("x2",`${Ve(e.x)}`),i.setAttribute("y2",`${Ve(e.y)}`),i}function Ve(t){return`${parseFloat(t.toFixed(1))}`}class Xe{constructor(t,e,i,n){this.properties=new Le,this.theme=i,this.settings=n,this.properties.viewSize={w:t.w*e,h:t.h*e},this.properties.size={w:this.calculateRulerWidth(this.properties.viewSize),h:this.settings.height},this.properties.scale=e;const s=Math.min(this.properties.viewSize.w,this.properties.viewSize.h)/2;this.properties.position={x:s,y:s},this.properties.rotation=this.settings.initialAngle}calculateRulerWidth(t){return Math.round(3*Math.sqrt(t.w*t.w+t.h*t.h))}}function Ye(t,e){return 0===e||t%e==0?t:(Math.floor(t/e)+1)*e}function _e(t,e,i){return t.x>-i&&t.x<e.w+i&&t.y>-i&&t.y<e.h+i}function Be(t,e){const i=function(t,e){let i=!0;return function(t,e,i,n){if(0===i||i%180==0)return e>=0&&e<=n.h;if(i%90==0)return t>=0&&t<=n.w;const s=Math.tan(be(i)),o=e-t*s;if(o>=0&&o<=n.h)return!0;const r=t-e/s;if(r>=0&&r<=n.w)return!0;const a=(n.w-t)*s+e;if(a>=0&&a<=n.h)return!0;const h=(n.h-e)/s+t;return h>=0&&h<=n.w}(e.position.x+t.position.x,e.position.y+t.position.y,e.rotation+t.rotation,e.viewSize)||(t.position.x=0,t.position.y=0,t.rotation=0,i=!1),i}(t,e);return i&&function(t,e){const i=st(e.position,t.position),n=e.rotation+t.rotation,s=e.size.w/2,o=s/3,r=be(n),a=Math.cos(r),h=Math.sin(r),u={x:i.x+s*a,y:i.y+s*h},c={x:i.x-s*a,y:i.y-s*h};let l=0;if(_e(u,e.viewSize,o)?l=je(i,u,n,e.viewSize,o):_e(c,e.viewSize,o)&&(l=-je(i,c,n,e.viewSize,o)),0!==l){const n={x:l*a,y:l*h},s=st(i,n);t.position=rt(s,e.position),_e(st(e.compassOffset,e.position),e.viewSize,o)&&(t.compassOffset=rt(t.compassOffset,n))}}(t,e),i}function je(t,e,i,n,s){if(0===i||i%180==0)return Math.abs(e.x+2*s)<Math.abs(e.x-(2*s+n.w))?Ye(Math.abs(e.x+2*s),Oe):Ye(Math.abs(e.x-(2*s+n.w)),Oe);if(i%90==0)return Math.abs(e.y+2*s)<Math.abs(e.y-(2*s+n.h))?Ye(Math.abs(e.y+2*s),Oe):Ye(Math.abs(e.y-(2*s+n.h)),Oe);{const o=be(i),r=Math.tan(o);let a,h,u,c;return h=Math.abs(e.x-(2*s+n.w)),a=h,u=2*s+n.w,c=(u-t.x)*r+t.y,h=Math.abs(e.x+2*s),h<a&&(a=h,u=-2*s,c=(u-t.x)*r+t.y),h=Math.abs(e.y-(2*s+n.h)),h<a&&(a=h,c=2*s+n.h,u=(c-t.y)/r+t.x),h=Math.abs(e.y+2*s),h<a&&(a=h,c=-2*s,u=(c-t.y)/r+t.x),Ye(Math.sqrt(Math.pow(u-e.x,2)+Math.pow(c-e.y,2)),Oe)}}var $e,Ge;!function(t){t.Move="move",t.Rotate="rotate",t.MoveAndRotate="moveAndRotate"}($e||($e={})),function(t){t.Snapped="snapped",t.NotSnapped="notSnapped"}(Ge||(Ge={}));class Ke{constructor(t){this.dataNames=["InputType","Activity","Angle","SnappedState"],this.inkLogName="RulerUsage",this.logger=t}logActivity(t,e,i,n,s){const o=this.getActivityType(e,i);if(void 0!==o){const e=[t,o,n,s?Ge.Snapped:Ge.NotSnapped];this.logger.logActivity(this.inkLogName,0,this.dataNames,e)}}getActivityType(t,e){return t&&e?$e.MoveAndRotate:t?$e.Move:e?$e.Rotate:void 0}}class qe{constructor(t,e,i,n,s=new Ee,o="Ruler: {{param0}} degrees",r,a=!0,h){this.parentElement=t,this.state=new Xe({w:t.clientWidth,h:t.clientHeight},e,i,n),this.considerScaleWithSnapWidth=a;const u=this.computeScaleToConsiderWithSnapWidth();this.rulerModel=new At(at(this.state.properties.position,1/u),be(this.state.properties.rotation),this.state.settings.height/(2*u),this.state.settings.snapWidth/u),this.renderer=new De(t,this.state,s,o),this.manipulation=new Ae(this,r,h)}activate(){this.manipulation.activate(),this.rulerModel.activate()}deactivate(){this.manipulation.deactivate(),this.rulerModel.deactivate()}fixFirefoxMultitouch(t){this.manipulation.setFixFirefoxMultitouch(t)}resetManipulationState(){this.manipulation.resetManipulationState()}setLogger(t){this.manipulation.setLogger(new Ke(t))}setUseBrowserSpecificTransform(t){this.manipulation.setUseBrowserSpecificTransform(t)}getPointerEventsElement(){return this.parentElement}getTheme(){return this.state.theme}getSettings(){return this.state.settings}getProperties(){return this.state.properties}getRulerModel(){return this.rulerModel}setTheme(t){this.state.theme=t,this.renderer.themeChanged(this.state.theme)}setScale(t){Pt(this.state.properties.scale,t)&&(this.state.properties.scale=t,this.renderer.scaleChanged(this.state),this.resetModel())}setViewSize(t,e){const i=t*this.state.properties.scale,n=e*this.state.properties.scale;if(Pt(this.state.properties.viewSize.w,i)||Pt(this.state.properties.viewSize.h,n)){const t={w:i,h:n};this.state.properties.viewSize=t,this.state.properties.size.w=this.state.calculateRulerWidth(t),this.renderer.viewSizeChanged(this.state)}}setVisibility(t){this.state.properties.visible!==t&&(this.state.properties.visible=t,this.renderer.setVisibility(t))}setOpacity(t){Pt(this.state.properties.opacity,t)&&(this.state.properties.opacity=t,this.renderer.setOpacity(t))}move(t,e){const i=new Le;i.position.x=t,i.position.y=e,Be(i,this.state.properties),this.updateState(i)}rotate(t){const e=new Le;if(e.rotation=t,St(this.state.properties.compassOffset.x)||St(this.state.properties.compassOffset.y)){const t=st(this.state.properties.compassOffset,this.state.properties.position);!function(t,e,i){const n=be(t.rotation),s=rt(e.position,i),o=Math.cos(n),r=Math.sin(n),a=s.x*o-s.y*r,h=s.x*r+s.y*o;t.position.x+=a-s.x,t.position.y+=h-s.y}(e,this.state.properties,t),function(t,e,i){const n=st(e.position,t.position),s=Tt(i,xt(n,be(e.rotation+t.rotation%180)));t.compassOffset={x:s.x-e.compassOffset.x-n.x,y:s.y-e.compassOffset.y-n.y}}(e,this.state.properties,t)}Be(e,this.state.properties),this.updateState(e)}setCompassPosition(t){const e=rt(Tt(t,xt(this.state.properties.position,be(this.state.properties.rotation))),this.state.properties.position),i=new Le;i.compassOffset=rt(e,this.state.properties.compassOffset),this.updateState(i)}setAriaLabel(t){this.renderer.setAriaLabel(t)}setAriaDescription(t){this.renderer.setAriaDescription(t)}computeScaleToConsiderWithSnapWidth(){return this.considerScaleWithSnapWidth?this.state.properties.scale:1}updateState(t){const e=t.position.x,i=t.position.y;(St(e)||St(i))&&(this.state.properties.position.x+=e,this.state.properties.position.y+=i,this.renderer.setPosition(this.state.properties.position));const n=t.compassOffset.x,s=t.compassOffset.y;(St(n)||St(s))&&(this.state.properties.compassOffset.x+=n,this.state.properties.compassOffset.y+=s,function(t,e){e.setCompassPosition(t.compassOffset);const i=ut(t.compassOffset,{x:0,y:0},be(-t.rotation)),n={x:e.getInternalSize().w/2+i.x,y:e.getInternalSize().h/2};e.setAngleIndicatorPosition(n)}(this.state.properties,this.renderer));const o=t.rotation;St(o)&&(this.state.properties.rotation=(this.state.properties.rotation+o)%360,this.renderer.setRotation(this.state.properties.rotation)),this.resetModel()}resetModel(){const t=this.computeScaleToConsiderWithSnapWidth();this.rulerModel.reset(at(this.state.properties.position,1/t),be(this.state.properties.rotation),this.state.settings.height/(2*t),this.state.settings.snapWidth/t)}}const Je={opacityUntouched:.9,opacityTouched:.75,height:120,borderThickness:1,tickMarkThickness:1,compassDiameter:64,angleIndicatorThickness:3,initialAngle:45,snapWidth:30},Ze={angleTextColor:{r:0,g:0,b:0,a:1},backgroundColor:{r:230,g:230,b:230,a:1},borderColor:{r:0,g:0,b:0,a:1},tickMarkColor:{r:0,g:0,b:0,a:1},angleIndicatorColor:{r:255,g:0,b:0,a:1}};var Qe="stencilContainer";function ti(t,e,i){void 0===i&&(i=Qe);var n=ei(i);n&&(n.setAttribute("width",""+t),n.setAttribute("height",""+e))}function ei(t){void 0===t&&(t=Qe);try{return function(t,e){const i=document.getElementById(t);if(null===i)throw new Error(`Could not find element with id: ${t}`);return i}(t)}catch(t){return null}}var ii=function(){function t(){this.active=!1}return t.prototype.setup=function(t,e,i){t&&(this.rulerManager=new qe(t,1,e,i,void 0,"",void 0,!1),this.rulerManager.setLogger(n),this.rulerManager.setUseBrowserSpecificTransform(!1))},t.prototype.isActive=function(){return this.active},t.prototype.activate=function(e){var i;t.INSTANCE.setScale(e),this.isActive()||(void 0===this.rulerManager&&this.setup(ei(),Ze,Je),null===(i=this.rulerManager)||void 0===i||i.activate(),this.active=!0)},t.prototype.deactivate=function(){var t;null===(t=this.rulerManager)||void 0===t||t.deactivate(),this.active=!1},t.prototype.getRulerModel=function(){var t;return null===(t=this.rulerManager)||void 0===t?void 0:t.getRulerModel()},t.prototype.setScale=function(t){var e;t>0&&(null===(e=this.rulerManager)||void 0===e||e.setScale(t))},t.prototype.isUnderRuler=function(t,e,i){return!!this.isActive()&&!!this.rulerManager&&this.rulerManager.getRulerModel().isUnderRuler(t,e,i)},t.INSTANCE=new t,t}(),ni=function(){function t(t,e){this.hapticsExtractor=new p,this.playHapticsInterval=0,this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!1,this.inkDryStore=t,this.hitTestDataMap=new Map,this.shapeNodesErased=new Set,this.viewModelModifier=e}return t.prototype.onPointerDown=function(t){this.hapticsExtractor.onPointerDown(t),this.previousPoint={x:t.offsetX,y:t.offsetY},this.generateHitTestData()},t.prototype.onPointerMove=function(t){var e=this,i={x:t.offsetX,y:t.offsetY};if(ii.INSTANCE.isUnderRuler(i,.5,y))this.previousPoint=i;else{this.hapticsExtractor.onPointerMove(t);var n=new Set;this.hitTestDataMap.forEach((function(t,s){var o=!1,r=16-fe(t.bounds),a=16-ge(t.bounds);r>=0&&a>=0&&we(e.previousPoint,i,t.bounds,r/2,a/2)?o=!0:Se(e.previousPoint,i,t.bounds)&&t.strokeCollection.stream({add:function(t){!o&&xe(t,e.previousPoint,i)&&(o=!0)}}),o&&n.add(s)})),n.forEach((function(t){e.shapeNodesErased.add(t),e.hitTestDataMap.delete(t)})),this.hideInkCollections(n),0!==n.size&&this.ensurePlayStrokeHitHaptics(),this.previousPoint=i}},t.prototype.onPointerUp=function(t){this.hapticsExtractor.onPointerUp(t),this.clearHaptics(),this.hitTestDataMap.clear(),this.deleteInkCollections(this.shapeNodesErased),this.shapeNodesErased.size>0&&O.info("Strokes erased count: "+this.shapeNodesErased.size+". Pointer type: "+t.pointerType+"."),this.shapeNodesErased.clear(),O.info("Action: Eraser. PointerType: "+t.pointerType+".")},t.prototype.generateHitTestData=function(){this.hitTestDataMap=this.inkDryStore.generateHitTestData()},t.prototype.deleteInkCollections=function(t){var e=this;t.forEach((function(i){e.inkDryStore.unregisterInk(i)||t.delete(i)}));var i=[];t.forEach((function(t){i.push(t)})),this.viewModelModifier.deleteInkCollections(i)},t.prototype.hideInkCollections=function(t){var e=[];t.forEach((function(t){e.push(t)})),this.viewModelModifier.hideInkCollections(e)},t.prototype.ensurePlayStrokeHitHaptics=function(){var t=this;this.needPlayStrokeHitHaptics=!0,0===this.playHapticsInterval&&(this.playHapticsInterval=window.setInterval((function(){return t.playStrokeEraserHaptics()}),50))},t.prototype.clearHaptics=function(){0!==this.playHapticsInterval&&(this.hapticsExtractor.stop(),window.clearInterval(this.playHapticsInterval),this.playHapticsInterval=0,this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!1)},t.prototype.playStrokeEraserHaptics=function(){var t,e=this;this.needPlayStrokeHitHaptics?(this.hapticsExtractor.play((function(){return l({waveformId:i.WAVEFORM_CLICK,intensity:e.hapticsExtractor.isPointerDown?1:.75,vendorId:"",alternates:[]})})),this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!0):this.needRestartContinuousHaptics&&(null===(t=this.hapticsExtractor)||void 0===t||t.play((function(){return l({waveformId:i.WAVEFORM_ERASER_CONTINUOUS,intensity:1,vendorId:"",alternates:[]})})),this.needRestartContinuousHaptics=!1)},t}();function si(t){t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore()}const oi={alpha:!0,desynchronized:!1};function ri(t,e,i,n,s){const o=function(t,e){const i=t.getContext("2d",e);if(null===i)throw new Error("Could not get 2D context from canvas.");return i}(t,s);return function(t,e,i,n,s){(function(t,e,i,n){t.style.width=`${i}px`,t.style.height=`${n}px`,t.width=i*e,t.height=n*e})(t,e,n,s),i.setTransform(1,0,0,1,0,0),i.scale(e,e)}(t,e,o,i,n),o}function ai(t,e,i,n){return ri(t,e,i,n,oi)}class hi{constructor(){this.id=0,this.drawingAttributes=y,this.points=[]}streamChannels(t){this.points.forEach((e=>{t.addPoint(e),t.addPressure(function(t){return t.pressure}(e)),t.addTilt(e),t.addTimestamp(function(t){return t.timestamp}(e))}))}streamPoints(t){this.points.forEach((e=>{t.add(e)}))}streamPath(t){ui(this,t,0)}stream(t){ci(this,t,0)}add(t){this.points.push(t)}}function ui(t,e,i){if(i+2>t.points.length)return i;e.beginStroke(t.points[i]);for(let n=i+1;n<t.points.length-1;n+=1)e.addPoint(t.points[n]);return e.endStroke(t.points[t.points.length-1]),t.points.length-1}function ci(t,e,i){return e.setDrawingAttributes(1===t.drawingAttributes.effect.type&&t.points.length>0?new w(t.drawingAttributes).setEffect({type:1,pattern:t.drawingAttributes.effect.pattern,offsetX:t.drawingAttributes.effect.offsetX+t.points[i].x-t.points[0].x,offsetY:t.drawingAttributes.effect.offsetY+t.points[i].y-t.points[0].y}).build():t.drawingAttributes),ui(t,e,i)}class li{beginStroke(t){this.output.add(t)}addPoint(t){this.output.add(t)}endStroke(t){this.output.add(t)}}class pi{constructor(t,e,i){this.context=t,this.fillStyle=e,this.strokeStyle=i}setDrawingAttributes(){}beginStroke(t){this.context.save(),this.context.lineCap="butt",this.context.lineJoin="miter",this.context.setLineDash([5,5]),this.context.fillStyle=this.fillStyle,this.context.strokeStyle=this.strokeStyle,this.context.beginPath(),this.context.moveTo(t.x,t.y)}addPoint(t){this.context.lineTo(t.x,t.y)}endStroke(t){this.addPoint(t),this.context.closePath(),this.context.fill(),this.context.stroke(),this.context.restore()}}var di,fi=function(){function t(t,e,i,n){this.adapter=new li,this.lassoStroke=new hi,this.hapticsExtractor=new p,this.inkDryStore=t,this.transform=n?new B:new _,H(this.hapticsExtractor,this.transform,this.adapter,this.lassoStroke),this.context=ai(e,window.devicePixelRatio,e.clientWidth,e.clientHeight),this.renderer=new pi(this.context,"rgba(128, 128, 128, 0.39)","#9b9b9b"),this.viewModelModifier=i,this.hitTestDataMap=new Map}return t.prototype.onPointerDown=function(t){this.hapticsExtractor.onPointerDown(t),this.generateHitTestData(),this.viewModelModifier.clearSelection()},t.prototype.onPointerMove=function(t){this.hapticsExtractor.onPointerMove(t),si(this.context),this.lassoStroke.streamPath(this.renderer)},t.prototype.onPointerUp=function(t){this.hapticsExtractor.onPointerUp(t),this.hitTest(t.pointerType),this.lassoStroke=new hi,H(this.hapticsExtractor,this.transform,this.adapter,this.lassoStroke),si(this.context),O.info("Action: Lasso. PointerType: "+t.pointerType+".")},t.prototype.hitTest=function(t){var e=this,n=[];this.hitTestDataMap.forEach((function(t,i){var s=!1;t.strokeCollection.stream({add:function(t){!s&&function(t,e,i){const{enclosed:n,total:s}=function(t,e){let i=0,n=0;return t.streamPoints({add:t=>{(function(t,e){let i,n,s=0,o=0;const r={x:1e11,y:20},a=e=>{Pe(n,e,t,r)&&(s+=1),n=e,o+=1},h={add:t=>{i=t,n=t,o+=1,h.add=a}};return e.streamPoints(h),!(o<3)&&(a(i),s%2==1)})(t,e)&&(i+=1),n+=1}}),{enclosed:i,total:n}}(t,e);return n/s>.6}(t,e.lassoStroke)&&(s=!0)}}),s&&n.push(i)})),O.info("Strokes lassoed count: "+n.length+". Pointer type: "+t+"."),0!==n.length&&this.hapticsExtractor.play((function(){return l({waveformId:i.WAVEFORM_CLICK,intensity:e.hapticsExtractor.isPointerDown?1:.75,vendorId:"",alternates:[]})})),this.viewModelModifier.selectInkCollections(n)},t.prototype.generateHitTestData=function(){this.hitTestDataMap=this.inkDryStore.generateHitTestData()},t}();function gi(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function mi(t){const e=me();return t.streamPoints({add:t=>{ve(e,t)}}),e}class vi{constructor(){this.baseId=0}generate(){return this.baseId+=1}setBaseId(t){this.baseId=t}}function yi(t,e){return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}function Si(t,e){return t.x>=e.left&&t.x<=e.right&&t.y>=e.top&&t.y<=e.bottom}function wi(t,e){return t.x>e.left&&t.x<e.right&&t.y>e.top&&t.y<e.bottom}function Pi(t,e,i,n,s,o,r,a){switch(t){case di.LineFullyInside:case di.LineIntersectsCorner:return;case di.LineFromOutsideToInside:{const t=Ei(e,i,s,o,r);return void a.push(t)}case di.LineFromInsideToOutside:{const t=Ei(e,n,s,o,r);return void a.push(t)}case di.LineFromOutsideToOutside:{const t=Ei(e,i,s,o,r);a.push(t);const h=Ei(e,n,s,o,r);return void a.push(h)}default:throw Error("Unexpected intersection between bounding box and stroke")}}function ki(t,e,i){const n=t[i],s=n.intersectPoint,o=n.prevPoint;if(0===i&&wt(s.x,e[0].x)&&wt(s.y,e[0].y))return;let r=n.prevIndex;if(wt(s.x,o.x)&&wt(s.y,o.y)&&r--,0===i)return e[r];const a=t[i-1];return a.prevIndex===r?a.intersectPoint:e[r]}function xi(t,e,i){const n=t[i],s=n.intersectPoint,o=n.nextPoint;if(i===t.length-1&&wt(s.x,e[e.length-1].x)&&wt(s.y,e[e.length-1].y))return;let r=n.nextIndex;if(wt(s.x,o.x)&&wt(s.y,o.y)&&r++,i===t.length-1)return e[r];const a=t[i+1];return a.nextIndex===r?a.intersectPoint:e[r]}function bi(t,e){return 0===t&&1===e?di.LineFullyInside:t===e&&0!==t&&1!==t?di.LineIntersectsCorner:1===e||0===t?1===e?di.LineFromOutsideToInside:di.LineFromInsideToOutside:di.LineFromOutsideToOutside}function Ei(t,e,i,n,s){const o=st({x:i.x,y:i.y},at(t,e)),r=function(t,e,i){const n=e.pressure,s=i.pressure;if(Math.abs(s-n)<.1)return n;let o=i.x-e.x,r=t.x-e.x;if(0===o&&(o=i.y-e.y,r=t.y-e.y,0===o))throw Error("Unexpected error: y coordinates of endpoints of vertical line are the same. This function should not be called.");const a=r/o;return n*(1-a)+s*a}(o,i,n);return{intersectPoint:{x:o.x,y:o.y,pressure:r,tiltX:n.tiltX,tiltY:n.tiltY,timestamp:n.timestamp},prevPoint:i,nextPoint:n,prevIndex:s-1,nextIndex:s}}function Ti(t,e){return{left:t.x-e,right:t.x+e,top:t.y-e,bottom:t.y+e}}!function(t){t[t.LineFullyInside=0]="LineFullyInside",t[t.LineIntersectsCorner=1]="LineIntersectsCorner",t[t.LineFromOutsideToInside=2]="LineFromOutsideToInside",t[t.LineFromInsideToOutside=3]="LineFromInsideToOutside",t[t.LineFromOutsideToOutside=4]="LineFromOutsideToOutside",t[t.LineFromOutsideToCornerIn=5]="LineFromOutsideToCornerIn",t[t.LineFromOutsideToCornerOut=6]="LineFromOutsideToCornerOut",t[t.LineFromCornerToInside=7]="LineFromCornerToInside",t[t.LineFromCornerToOutside=8]="LineFromCornerToOutside",t[t.LineFromOutsideToEdge=9]="LineFromOutsideToEdge",t[t.LineFromEdgeToOutside=10]="LineFromEdgeToOutside"}(di||(di={}));class Mi{constructor(t){this.drawingAttributes=y,this.newSplitStrokes=[],this.idGenerator=t}splitByIntersections(t,e,i,n=!1){return this.newSplitStrokes=[],this.drawingAttributes=t.drawingAttributes,this.buildStrokes(t,e,i),n?this.pruneSmallStrokes(this.newSplitStrokes):this.newSplitStrokes}updateStrokeDrawingAttributes(t,e){const{effect:i}=t.drawingAttributes;if(1===i.type){const n=t.points[0].x-e[0].x+i.offsetX,s=t.points[0].y-e[0].y+i.offsetY;t.drawingAttributes=Object.assign(Object.assign({},this.drawingAttributes),{effect:Object.assign(Object.assign({},i),{offsetX:n,offsetY:s})})}return t}buildStrokes(t,e,i){const n=[];t.streamPoints({add:t=>{n.push(t)}}),Si(n[0],e)?this.buildStrokeSegments(n,0,i):(this.newSplitStrokes.push(this.createStroke(n,-1,0,i)),this.buildStrokeSegments(n,1,i))}buildStrokeSegments(t,e,i){for(let n=e;n<i.length;n+=2)n===i.length-1?this.newSplitStrokes.push(this.createStroke(t,n,-1,i)):this.newSplitStrokes.push(this.createStroke(t,n,n+1,i))}comparePointAndIntersection(t,e){const i=e.intersectPoint.x,n=e.intersectPoint.y;return t.x===i&&t.y===n}pruneSmallStrokes(t){return t.filter((t=>{const e=me();return t.streamPoints({add:t=>{ve(e,t)}}),Math.max(Math.abs(e.right-e.left),Math.abs(e.top-e.bottom))>t.drawingAttributes.width}))}createStroke(t,e,i,n){let s,o,r=new hi;r.id=this.idGenerator.generate(),r.drawingAttributes=this.drawingAttributes,-1===e?(s=0,o=n[i].prevIndex):-1===i?(s=n[e].nextIndex,o=t.length-1,r.add(n[e].intersectPoint)):(s=n[e].nextIndex,o=n[i].prevIndex,r.add(n[e].intersectPoint));for(let a=s;a<=o;a++)e>=0&&a===s?this.comparePointAndIntersection(t[a],n[e])||r.add(t[a]):i>=0&&a===o&&this.comparePointAndIntersection(t[a],n[i])||r.add(t[a]);return-1!==i&&r.add(n[i].intersectPoint),r=this.updateStrokeDrawingAttributes(r,t),r}}function Ii(t){const e=me();return t.stream({add:t=>{ye(e,mi(t))}}),e}class Ai{constructor(){this.strokes=[]}add(t){this.strokes.push(t)}stream(t){this.strokes.forEach((e=>{t.add(e)}))}}const Ci={tiltX:0,tiltY:0};class Li{constructor(){this.id=0,this.drawingAttributes=y,this.points=[],this.pressures=[],this.tilts=[],this.timestamps=[]}streamChannels(t){this.points.forEach((e=>{t.addPoint(e)})),this.pressures.forEach((e=>{t.addPressure(e)})),this.tilts.forEach((e=>{t.addTilt(e)})),this.timestamps.forEach((e=>{t.addTimestamp(e)}))}streamPoints(t){this.points.forEach(((e,i)=>{t.add(this.getPoint(i))}))}streamPath(t){if(!(this.points.length<2)){t.beginStroke(this.getPoint(0));for(let e=1;e<this.points.length-1;e+=1)t.addPoint(this.getPoint(e));t.endStroke(this.getPoint(this.points.length-1))}}stream(t){t.setDrawingAttributes(this.drawingAttributes),this.streamPath(t)}addPoint(t){this.points.push(t)}addPressure(t){this.pressures.push(t)}addTilt(t){this.tilts.push(t)}addTimestamp(t){this.timestamps.push(t)}getPressure(t){return this.pressures.length>t?this.pressures[t]:F}getTilt(t){return this.tilts.length>t?this.tilts[t]:Ci}getTimestamp(t){return this.timestamps.length>t?this.timestamps[t]:0}getPoint(t){return e=this.points[t],i=this.getPressure(t),n=this.getTilt(t),s=this.getTimestamp(t),{x:e.x,y:e.y,pressure:i,tiltX:n.tiltX,tiltY:n.tiltY,timestamp:s};var e,i,n,s}}function Oi(t){const e=new Ai;return JSON.parse(t).forEach((t=>{e.add(function(t){return function(t){if(t.x.length!==t.y.length)throw new Error("X & Y don't match");if(0!==t.pressure.length&&t.pressure.length!==t.x.length)throw new Error("Pressure don't match X");if(t.tiltX.length!==t.tiltY.length)throw new Error("Tilt X & Y don't match");if(0!==t.tiltX.length&&t.tiltX.length!==t.x.length)throw new Error("Tilts don't match X.");if(0!==t.timestamp.length&&t.timestamp.length!==t.x.length)throw new Error("Timestamp don't match X")}(t),t.x.length===t.pressure.length&&t.x.length===t.tiltX.length&&t.x.length===t.timestamp.length?function(t){const e=new hi;return e.drawingAttributes=t.drawingAttributes,e.id=t.id,t.x.forEach(((i,n)=>{e.add({x:i,y:t.y[n],pressure:t.pressure[n],tiltX:t.tiltX[n],tiltY:t.tiltY[n],timestamp:t.timestamp[n]})})),e}(t):function(t){const e=new Li;return e.drawingAttributes=t.drawingAttributes,e.id=t.id,t.x.forEach(((i,n)=>{e.addPoint({x:i,y:t.y[n]})})),t.pressure.forEach((t=>{e.addPressure(t)})),t.tiltX.forEach(((i,n)=>{e.addTilt({tiltX:i,tiltY:t.tiltY[n]})})),t.timestamp.forEach((t=>{e.addTimestamp(t)})),e}(t)}(t))})),e}function Di(t){const e=[];return t.stream({add:t=>{e.push(function(t){const e={id:t.id,drawingAttributes:t.drawingAttributes,x:[],y:[],pressure:[],tiltX:[],tiltY:[],timestamp:[]};return t.streamChannels({addPoint:t=>{e.x.push(t.x),e.y.push(t.y)},addPressure:t=>{e.pressure.push(t)},addTilt:t=>{e.tiltX.push(t.tiltX),e.tiltY.push(t.tiltY)},addTimestamp:t=>{e.timestamp.push(t)}}),JSON.stringify(e)}(t))}}),`[${e.join(",")}]`}function Ri(t,e){return function(i){return{x:i.x+t,y:i.y+e,tiltX:i.tiltX,tiltY:i.tiltY,pressure:i.pressure,timestamp:i.timestamp}}}function Ni(t,e){var i=new Ai,n=new vt;n.transform=e;var s=new li;return t.stream({add:function(t){var e=new hi;e.id=t.id,e.drawingAttributes=t.drawingAttributes,U(n,s,e),t.streamPath(n),i.add(e)}}),i}function Ui(t,e){return Ni(t,function(t){return function(e){return{x:e.x*t,y:e.y*t,tiltX:e.tiltX,tiltY:e.tiltY,pressure:e.pressure,timestamp:e.timestamp}}}(e))}function Hi(t,e){if(0===e)return t;var i=Ii(t);return function(t,e,i,n){return Ni(t,function(t,e,i){var n=i*Math.PI/180,s=Math.cos(n),o=Math.sin(n);return function(i){var n=i.x-t,r=i.y-e;return{x:n*s-r*o+t,y:n*o+r*s+e,tiltX:i.tiltX,tiltY:i.tiltY,pressure:i.pressure,timestamp:i.timestamp}}}(e,i,n))}(t,(i.right-i.left)/2,(i.bottom-i.top)/2,e)}function Fi(t,e,i){return Ni(t,Ri(e,i))}function Wi(t){var e=Ii(t);return Fi(t,-e.left,-e.top)}var zi=function(){function t(t,e){this.zoom=1,this.inkObjectsMap=new Map,this.slideViewElement=t,this.slideViewportElement=e,this.enablePointEraser=!1}return t.prototype.updateSlideElements=function(t,e){this.slideViewElement=t,this.slideViewportElement=e},t.prototype.registerInkWithStrokeCollection=function(e,i){if(!this.inkObjectsMap.has(i)){this.enablePointEraser=R.INSTANCE.getBooleanAppSetting("IsInkPartialEraserEnabled");var n=new Ai;e.forEach((function(t){n.add(t.stroke)}));var s=Wi(n);this.inkObjectsMap.set(i,{json:Di(s),strokeCollection:Ui(s,this.zoom),locationInSlideView:{x:Number.MAX_VALUE,y:Number.MAX_VALUE},rotation:0}),this.enablePointEraser&&t.StoreCollect.set(i,{strokeCollection:s,bounds:Ii(s)})}},t.prototype.unregisterInk=function(e){return this.enablePointEraser&&t.StoreCollect.has(e)&&t.StoreCollect.delete(e),this.inkObjectsMap.delete(e)},t.prototype.updateZoom=function(e){var i=this;if(this.zoom!==e){this.zoom=e;try{this.inkObjectsMap.forEach((function(e,n){var s=Hi(Ui(Oi(e.json),i.zoom),e.rotation);if(i.inkObjectsMap.set(n,{json:e.json,strokeCollection:s,locationInSlideView:e.locationInSlideView,rotation:e.rotation}),i.enablePointEraser&&t.StoreCollect.has(n)){var o=i.calculateDistanceBetweenSlideviewAndFishbowl(),r=Fi(s,e.locationInSlideView.x*i.slideViewElementScale+o.x,e.locationInSlideView.y*i.slideViewElementScale+o.y);t.StoreCollect.set(n,{strokeCollection:r,bounds:Ii(r)})}}))}catch(t){O.info("Unable to deserialize JSON in updateZoom. Excepton: "+t)}}},t.prototype.updateInkSlideViewLocation=function(e,i,n,s,o){if(this.inkObjectsMap.has(e)){var r=this.inkObjectsMap.get(e);if(void 0!==r){if(void 0!==s&&s.length>0&&(s!==r.json||o!==r.rotation))try{var a=Wi(Oi(s)),h=Hi(Ui(a,this.zoom),o);if(this.inkObjectsMap.set(e,{json:Di(a),strokeCollection:h,locationInSlideView:{x:i,y:n},rotation:o}),this.enablePointEraser&&t.StoreCollect.has(e)){var u=this.calculateDistanceBetweenSlideviewAndFishbowl(),c=Fi(h,i*this.slideViewElementScale+u.x,n*this.slideViewElementScale+u.y);t.StoreCollect.set(e,{strokeCollection:c,bounds:Ii(c)})}return}catch(t){return void O.info("Unable to deserialize JSON in updateInkSlideViewLocation. Excepton: "+t)}void 0!==s&&0!==s.length||O.info("Incoming JSON was undefined or of zero length!"),this.inkObjectsMap.set(e,{json:r.json,strokeCollection:r.strokeCollection,locationInSlideView:{x:i,y:n},rotation:r.rotation}),this.enablePointEraser&&t.StoreCollect.has(e)&&(u=this.calculateDistanceBetweenSlideviewAndFishbowl(),c=Fi(r.strokeCollection,i*this.slideViewElementScale+u.x,n*this.slideViewElementScale+u.y),t.StoreCollect.set(e,{strokeCollection:c,bounds:Ii(c)}))}}},t.prototype.clearStore=function(){this.enablePointEraser&&t.StoreCollect.clear(),this.inkObjectsMap.clear()},Object.defineProperty(t.prototype,"slideViewElementScale",{get:function(){var t,e=1;return R.INSTANCE.getBooleanAppSetting("EnableZoomSlideOptimization")&&(null===(t=this.slideViewElement)||void 0===t?void 0:t.offsetHeight)&&(e=this.slideViewElement.getBoundingClientRect().width/this.slideViewElement.offsetWidth),e},enumerable:!1,configurable:!0}),t.prototype.generateHitTestData=function(){var t=this,e=new Map,i=this.calculateDistanceBetweenSlideviewAndFishbowl();return this.inkObjectsMap.forEach((function(n,s){var o=Fi(n.strokeCollection,n.locationInSlideView.x*t.slideViewElementScale+i.x,n.locationInSlideView.y*t.slideViewElementScale+i.y);e.set(s,{strokeCollection:o,bounds:Ii(o)})})),e},t.prototype.calculateDistanceBetweenSlideviewAndFishbowl=function(){return void 0!==this.slideViewElement&&void 0!==this.slideViewportElement?{x:this.slideViewElement.getBoundingClientRect().left-this.slideViewportElement.getBoundingClientRect().left,y:this.slideViewElement.getBoundingClientRect().top-this.slideViewportElement.getBoundingClientRect().top}:{x:0,y:0}},t.StoreCollect=new Map,t}();function Vi(){}class Xi{constructor(t){this.idGenerator=new vi,this.currentStroke=new hi,this.isLineMode=!1,this.inputStrokes=[],this.newPointsIndex=0,this.noop={add:Vi},this.output=this.noop,this.beginEndSink=t}setDrawingAttributes(t){this.currentStroke.drawingAttributes=t}beginStroke(t){this.newPointsIndex=0,this.currentStroke.id=this.idGenerator.generate(),this.beginEndSink.onStrokeBegin(),this.output=this.currentStroke,this.output.add(this.isLineMode?this.getConstantPressurePoint(t):t)}addPoint(t){this.isLineMode&&1===this.currentStroke.points.length?this.output.add(this.getConstantPressurePoint(t)):this.isLineMode&&this.currentStroke.points.length>1?this.currentStroke.points[this.currentStroke.points.length-1]=this.getConstantPressurePoint(t):this.output.add(t)}endStroke(t){this.output!==this.noop&&(this.isLineMode&&this.currentStroke.points.length>1?this.currentStroke.points[this.currentStroke.points.length-1]=this.getConstantPressurePoint(t):this.output.add(t),this.inputStrokes.push([this.currentStroke,this.newPointsIndex]),this.cancel())}makeCurrentStrokeStraight(){const t=this.currentStroke.points.length;t>=2&&(this.linePressure=this.getAveragePressureAcrossStroke(this.currentStroke),0===this.linePressure&&(this.linePressure=F),this.currentStroke.points.splice(1,t-2),this.currentStroke.points[0]=this.getConstantPressurePoint(this.currentStroke.points[0]),this.currentStroke.points[1]=this.getConstantPressurePoint(this.currentStroke.points[1]))}cancel(){this.output!==this.noop&&(this.output=this.noop,this.linePressure=void 0,this.currentStroke=new hi,this.beginEndSink.onStrokeEnd())}streamCollectedStrokes(t){this.inputStrokes.forEach((e=>{t.add(e[0]),e[1]=e[0].points.length-1}))}streamCollectedStrokesNewPoints(t){this.inputStrokes.forEach((e=>{e[1]=ci(e[0],t,e[1])}))}resetCollectedStrokes(){this.inputStrokes=[]}streamCurrentStroke(t){this.newPointsIndex=ci(this.currentStroke,t,0)}streamCurrentStrokeNewPoints(t){this.newPointsIndex=ci(this.currentStroke,t,this.newPointsIndex)}getAveragePressureAcrossStroke(t){let e=0;for(let i=0;i<t.points.length;i+=1)e+=t.points[i].pressure;return 0===e||0===t.points.length?0:e/t.points.length}getConstantPressurePoint(t){return void 0===this.linePressure&&(this.linePressure=0===t.pressure?F:t.pressure),{x:t.x,y:t.y,pressure:this.linePressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}}}var Yi=function(){function t(t){this.stroke=t}return t.prototype.getJSON=function(){var t=new Ai;return t.add(this.stroke),Di(t)},t.prototype.getBoundingBox=function(t,e){var i=mi(this.stroke);return i.left+=t,i.right+=t,i.top+=e,i.bottom+=e,i},t}(),_i=function(){function t(t){this.scale=t}return t.prototype.add=function(t){var e,i,n,s=new vt,o=mi(t);s.transform=(e=o.left/this.scale-o.left,i=o.top/this.scale-o.top,n=this.scale,function(t){return{x:(t.x+e)*n,y:(t.y+i)*n,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}});var r=new hi;r.id=t.id,r.drawingAttributes=t.drawingAttributes,U(s,new li,r),t.streamPath(s),this.output.add(r)},t}(),Bi=function(){function t(t){var e=this;this.strokeSink={add:function(){},begin:function(){},end:function(){}},this.collector=new Xi({onStrokeBegin:function(){e.strokeBeginEndListener.onStrokeBegin()},onStrokeEnd:function(){e.strokeBeginEndListener.onStrokeEnd()}}),this.zoom=t}return t.prototype.updateZoom=function(t){this.zoom=t},t.prototype.collectChanges=function(t,e){e?(this.collector.streamCurrentStrokeNewPoints(t),this.collector.streamCollectedStrokesNewPoints(t)):(this.collector.streamCurrentStroke(t),this.collector.streamCollectedStrokes({add:function(e){e.stream(t)}}))},t.prototype.setStrokeSink=function(t){this.strokeSink=t},t.prototype.setLineMode=function(t){this.collector.isLineMode=t},t.prototype.initializeDryStrokesCallback=function(){var t=this;this.strokeBeginEndListener.task=function(){t.strokeSink.begin();var e=new _i(1/t.zoom);N(e,{add:function(e){t.strokeSink.add(new Yi(e))}}),t.collector.streamCollectedStrokes(e),t.collector.resetCollectedStrokes(),t.strokeSink.end()}},t}(),ji=function(){function t(t,e){this.strokes_erased=0,this.sharedIdGenerator=new vi,this.startTimeDuration=0,this.endTimeDuration=0,this.erasingStarted=!1,this.hapticsExtractor=new p,this.playHapticsInterval=0,this.needPlayStrokeEraseHaptics=!1,this.eraserSize=20,this.dryStore=new Bi(1),this.inkDryStore=t,this.viewModelModifier=e,this.shapeNodesErased=new Set}return t.prototype.setInkStore=function(t){this.dryStore=t},t.prototype.onPointerDown=function(t){this.hapticsExtractor.onPointerDown(t),this.previousPoint={x:t.offsetX,y:t.offsetY},this.erasingStarted=!0,this.startTimeDuration=performance.now()},t.prototype.onPointerMove=function(t){this.hapticsExtractor.onPointerMove(t),this.erasingStarted&&(this.createPointerPacketFromPointerEvent(t),this.performPointErase(this.pointerPacket.point))},t.prototype.onPointerUp=function(t){this.hapticsExtractor.onPointerUp(t),this.clearHaptics(),this.deleteInkCollections(this.shapeNodesErased),this.shapeNodesErased.clear(),this.endTimeDuration=performance.now(),this.logMetrics(t.pointerType),this.strokes_erased=0},t.prototype.performPointErase=function(t){var e,i,n=this;if(ii.INSTANCE.isUnderRuler(t,.5,y))this.previousPoint=t;else{var s=function(t,e,i){const n=[],s=t/2,o=rt(i,e),r=Math.sqrt(ht(e,i));let a=Math.max(1,3*s/4);for(let t=0;t<=r;t+=a){const i=Ti(e,s);if(r>.2){const e={x:o.x*(t/r),y:o.y*(t/r)};h=i,u=e.x,c=e.y,h.left+=u,h.top+=c,h.right+=u,h.bottom+=c}t<r&&t+a>r&&(a=r-t),n.push(i)}var h,u,c;return n}(this.eraserSize,this.previousPoint,t),o=function(t){var e,i,s,o,a=new Map,h=[],u=new Set;zi.StoreCollect.forEach((function(e,i){var s=!1;e.strokeCollection.stream({add:function(e){var i=mi(e),o=function(t,e,i){let n=[];const s=[];if(t.streamPoints({add:t=>{s.push(t)}}),s.length<2)throw Error("The current stroke contains less than 2 points. This is unexpected behavior.");if(r=e,(o=i).top===o.bottom||o.left===o.right||r.top===r.bottom||r.left===r.right?o.right<r.left||o.bottom<r.top||o.top>r.bottom||o.left>r.right:o.right<=r.left||o.bottom<=r.top||o.top>=r.bottom||o.left>=r.right)return{intersections:n,hit:!1};if(function(t,e){return t.left>=e.left&&t.right<=e.right&&t.top>=e.top&&t.bottom<=e.bottom}(i,e))return{intersections:n,hit:!0};var o,r;for(let t=1;t<s.length;t++){const i=s[t-1],o=s[t];if(Se(i,o,e)){const s=rt(o,i),[r,a]=de(i,s,e);Pi(bi(r,a),s,r,a,i,o,t,n)}}n=function(t){const e=[];let i;for(const n of t){const t=n.intersectPoint;if(i){const e=t.x===i.x&&t.y===i.y,s=t.x===n.prevPoint.x&&t.y===n.prevPoint.y;if(e&&s){i={x:t.x,y:t.y};continue}}e.push(n),i={x:t.x,y:t.y}}return e}(n);const a=function(t,e,i){const n=new Set;for(let s=0;s<t.length;s++){const o=ki(t,e,s),r=xi(t,e,s);if(void 0===o)void 0!==r&&Si(yi(t[s].intersectPoint,r),i)&&n.add(s);else if(void 0===r)n.add(s);else{const e=yi(o,t[s].intersectPoint),a=yi(t[s].intersectPoint,r);(!wi(e,i)&&!wi(a,i)||wi(e,i)&&wi(a,i))&&n.add(s)}}return n}(n,s,e),h=[];for(let t=0;t<n.length;t++)a.has(t)||h.push(n[t]);return{intersections:h,hit:0!==h.length}}(e,t,i);o.hit&&(s=!0,n.ensurePlayStrokeErasedHaptics(),h.push(e),o.intersections.length>0&&!a.has(e.id)&&a.set(e.id,o.intersections))}}),s&&u.add(i)})),u.forEach((function(t){n.shapeNodesErased.add(t),zi.StoreCollect.delete(t)})),r.hideInkCollections(u);try{for(var c=(e=void 0,gi(h)),l=c.next();!l.done;l=c.next()){var p=l.value,d=[],f=a.get(p.id);if(r.strokes_erased++,f&&f.length>0){d=new Mi(r.sharedIdGenerator).splitByIntersections(p,t,f);var g=function(t){var e=[];t.streamPoints({add:function(t){var i={x:t.x,y:t.y,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp};e.push(i)}}),r.dryStore.collector.setDrawingAttributes(p.drawingAttributes),r.dryStore.collector.beginStroke(e[0]);for(var i=1;i<e.length-1;i++)r.dryStore.collector.addPoint(e[i]);r.dryStore.collector.endStroke(e[e.length-1])};try{for(var m=(s=void 0,gi(d)),v=m.next();!v.done;v=m.next())g(v.value)}catch(t){s={error:t}}finally{try{v&&!v.done&&(o=m.return)&&o.call(m)}finally{if(s)throw s.error}}}}}catch(t){e={error:t}}finally{try{l&&!l.done&&(i=c.return)&&i.call(c)}finally{if(e)throw e.error}}},r=this;try{for(var a=gi(s),h=a.next();!h.done;h=a.next())o(h.value)}catch(t){e={error:t}}finally{try{h&&!h.done&&(i=a.return)&&i.call(a)}finally{if(e)throw e.error}}this.previousPoint=t}},t.prototype.deleteInkCollections=function(t){var e=this;t.forEach((function(i){e.inkDryStore.unregisterInk(i)||t.delete(i)}));var i=[];t.forEach((function(t){i.push(t)})),this.viewModelModifier.deleteInkCollections(i)},t.prototype.hideInkCollections=function(t){var e=[];t.forEach((function(t){e.push(t)})),this.viewModelModifier.hideInkCollections(e)},t.prototype.createPointerPacketFromPointerEvent=function(t){var e={x:t.offsetX,y:t.offsetY};this.pointerPacket={tiltX:t.tiltX,tiltY:t.tiltY,pressure:t.pressure,timestamp:t.timeStamp,pageX:t.pageX,pageY:t.pageY,point:e}},t.prototype.logMetrics=function(t){var e=this.startTimeDuration,i=this.endTimeDuration-e;i=i>=0?i/1e3:0,n.logActivity("PointEraserUsage",i,["input_type","strokes_erased"],[t,this.strokes_erased])},t.prototype.clearHaptics=function(){0!==this.playHapticsInterval&&(this.hapticsExtractor.stop(),window.clearInterval(this.playHapticsInterval),this.playHapticsInterval=0)},t.prototype.ensurePlayStrokeErasedHaptics=function(){var t=this;this.needPlayStrokeEraseHaptics=!0,0===this.playHapticsInterval&&(this.playHapticsInterval=window.setInterval((function(){return t.playStrokeErasedHaptics()}),50))},t.prototype.playStrokeErasedHaptics=function(){this.needPlayStrokeEraseHaptics&&(this.hapticsExtractor.play((function(){return l({waveformId:i.WAVEFORM_SUCCESS,intensity:1,vendorId:"",alternates:[]})})),this.needPlayStrokeEraseHaptics=!1)},t}(),$i=function(){function t(t,e){this.hapticsExtractor=new p,this.playHapticsInterval=0,this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!1,this.inkDryStore=t,this.hitTestDataMap=new Map,this.shapeNodesErased=new Set,this.viewModelModifier=e}return t.prototype.onPointerDown=function(t){this.hapticsExtractor.onPointerDown(t),this.previousPoint={x:t.offsetX,y:t.offsetY},this.generateHitTestData()},t.prototype.onPointerMove=function(t){var e=this,i={x:t.offsetX,y:t.offsetY};if(ii.INSTANCE.isUnderRuler(i,.5,y))this.previousPoint=i;else{this.hapticsExtractor.onPointerMove(t);var n=new Set;this.hitTestDataMap.forEach((function(t,s){var o=!1,r=16-fe(t.bounds),a=16-ge(t.bounds);r>=0&&a>=0&&we(e.previousPoint,i,t.bounds,r/2,a/2)?o=!0:Se(e.previousPoint,i,t.bounds)&&t.strokeCollection.stream({add:function(t){!o&&xe(t,e.previousPoint,i)&&(o=!0)}}),o&&n.add(s)})),n.forEach((function(t){e.shapeNodesErased.add(t),e.hitTestDataMap.delete(t)})),this.hideInkCollections(n),0!==n.size&&this.ensurePlayStrokeHitHaptics(),this.previousPoint=i}},t.prototype.onPointerUp=function(t){this.hapticsExtractor.onPointerUp(t),this.clearHaptics(),this.hitTestDataMap.clear(),this.deleteInkCollections(this.shapeNodesErased),this.shapeNodesErased.size>0&&O.info("Strokes erased count: "+this.shapeNodesErased.size+". Pointer type: "+t.pointerType+"."),this.shapeNodesErased.clear(),O.info("Action: Eraser. PointerType: "+t.pointerType+".")},t.prototype.generateHitTestData=function(){this.hitTestDataMap=this.inkDryStore.generateHitTestData()},t.prototype.deleteInkCollections=function(t){var e=this;t.forEach((function(i){e.inkDryStore.unregisterInk(i)||t.delete(i)}));var i=[];t.forEach((function(t){i.push(t)})),this.viewModelModifier.deleteInkCollections(i)},t.prototype.hideInkCollections=function(t){var e=[];t.forEach((function(t){e.push(t)})),this.viewModelModifier.hideInkCollections(e)},t.prototype.ensurePlayStrokeHitHaptics=function(){var t=this;this.needPlayStrokeHitHaptics=!0,0===this.playHapticsInterval&&(this.playHapticsInterval=window.setInterval((function(){return t.playStrokeEraserHaptics()}),50))},t.prototype.clearHaptics=function(){0!==this.playHapticsInterval&&(this.hapticsExtractor.stop(),window.clearInterval(this.playHapticsInterval),this.playHapticsInterval=0,this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!1)},t.prototype.playStrokeEraserHaptics=function(){var t,e=this;this.needPlayStrokeHitHaptics?(this.hapticsExtractor.play((function(){return l({waveformId:i.WAVEFORM_CLICK,intensity:e.hapticsExtractor.isPointerDown?1:.75,vendorId:"",alternates:[]})})),this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!0):this.needRestartContinuousHaptics&&(null===(t=this.hapticsExtractor)||void 0===t||t.play((function(){return l({waveformId:i.WAVEFORM_ERASER_CONTINUOUS,intensity:1,vendorId:"",alternates:[]})})),this.needRestartContinuousHaptics=!1)},t}(),Gi=function(){function t(t,e,n,s,o,r,a,h,p,d,f){var g=this;if(this.isPenOnly=!1,this.enableLassoSelectManipulation=!1,this.enablePointEraser=!1,this.wasPointerDownForwarded=!1,this.wasPenDown=!1,this.isLassoing=!1,this.isActive=!1,this.store=n,this.pointEraser=new ji(s,r),this.strokeEraser=new $i(s,r),this.wetCanvas=o,this.drawingHaptics=p,this.enableLassoSelectManipulation=h,this.enablePointEraser=R.INSTANCE.getBooleanAppSetting("IsInkPartialEraserEnabled"),this.zoom=d,a?(this.drawer=new Ct(function(t,e=!1){return e?new gt(t):new ft(t)}(.5),new Ot((function(){return ii.INSTANCE.getRulerModel()}),(function(){return g.getDrawingAttributes()}))),U(this.drawer,this.injector=new pe,this.store.collector)):(this.drawer=new Ct(j(),new Ot((function(){return ii.INSTANCE.getRulerModel()}),(function(){return g.getDrawingAttributes()}))),H(this.drawer,new G,this.injector=new pe,this.store.collector)),this.eraser=new ni(s,r),this.lasso=new fi(s,o,r,h),this.enablePointEraser?this.outputSwitcher=new Gt(this.drawer,this.strokeEraser,this.lasso):this.outputSwitcher=new Gt(this.drawer,this.eraser,this.lasso),void 0!==window.PointerEvent)this.continuousHaptics=new Rt((function(){var t;if(g.outputSwitcher.output===g.drawer)t=g.drawingHaptics();else{if(g.outputSwitcher.output!==g.eraser&&(!g.enablePointEraser||g.outputSwitcher.output!==g.strokeEraser&&g.outputSwitcher.output!==g.pointEraser))return;t=i.WAVEFORM_ERASER_CONTINUOUS}return l({waveformId:t,intensity:1,vendorId:"",alternates:[]})})),H(this.input=new ee(t),this.continuousHaptics,{output:this.outputSwitcher,onPointerDown:function(t){try{o.setPointerCapture(t.pointerId)}catch(t){}f(t.shiftKey,t),(Wt(t)||Ft(t))&&g.store.strokeBeginEndListener.dryAllStrokes(),g.outputSwitcher.onPointerDown(t),R.INSTANCE.isChangeGateEnabled("PenDownHandlingEnabled")?mt(t)&&r.notifyPenDownOnCanvas():!g.isPenOnly&&mt(t)&&r.notifyPenDownOnCanvas()},onPointerMove:function(t){t.shiftKey&&!g.store.collector.isLineMode&&f(!0,t),g.outputSwitcher.onPointerMove(t)},onPointerUp:function(e){g.outputSwitcher.onPointerUp(e);try{o.releasePointerCapture(e.pointerId)}catch(t){}g.enableLassoSelectManipulation&&g.wasPointerDownForwarded&&(c(t),g.wasPointerDownForwarded=!1)}},this.outputSwitcher);else if(void 0!==window.TouchEvent){var m=new ae(t);U(m,new ce,this.outputSwitcher),this.input=m}else{var v=new Bt(t);U(v,new $t,this.outputSwitcher),this.input=v}N(this.pointerActivation=new Nt(e),new ie),N(this.pointerOverOut=new Ht(e),new Dt(t)),this.enableLassoSelectManipulation&&N(this.enableInputOnPointerDown=new Ut(e),{onPointerDown:function(e){g.wasPenDown=mt(e);var i=e.target;if(void 0!==i&&!r.isSelectionHandleClass(Array.from(i.classList))){u(t);var n=g.input;void 0!==n&&(g.wasPointerDownForwarded=!0,n.head.onPointerDown(e))}},onPointerUp:function(t){if(g.wasPointerDownForwarded){var e=g.input;void 0!==e&&e.head.onPointerUp(t)}},onPointerOver:function(e){mt(e)&&Ft(e)?u(t):c(t)},onTouchStart:function(t){g.isPenOnly&&g.wasPenDown&&Yt(t)}})}return t.prototype.getDrawingAttributes=function(){var t=this.injector.getDrawingAttributes();return new w(t).setWidth(t.width*this.zoom).setHeight(t.height*this.zoom).build()},t.prototype.isLassoMode=function(){return this.isLassoing&&this.isActive},t.prototype.activate=function(){var t;this.isActive=!0,this.input.activate(),this.activatePenOnly(),this.enableLassoSelectManipulation&&this.isLassoing&&(null===(t=this.enableInputOnPointerDown)||void 0===t||t.activate())},t.prototype.deactivate=function(){var t;this.isActive=!1,this.deactivatePenOnly(),this.input.deactivate(),this.enableLassoSelectManipulation&&this.isLassoing&&(null===(t=this.enableInputOnPointerDown)||void 0===t||t.deactivate())},t.prototype.activatePenOnly=function(){(!this.enableLassoSelectManipulation||this.enableLassoSelectManipulation&&!this.isLassoing)&&(this.pointerActivation.activate(),this.pointerOverOut.activate()),this.isPenOnly=!0},t.prototype.deactivatePenOnly=function(){this.isPenOnly=!1,(!this.enableLassoSelectManipulation||this.enableLassoSelectManipulation&&!this.isLassoing)&&(this.pointerOverOut.deactivate(),this.pointerActivation.deactivate())},t.prototype.setErasing=function(){this.enableLassoSelectManipulation&&this.stopLassoSelectManipulationInput(),this.outputSwitcher.normalOutput=this.eraser,this.store.strokeBeginEndListener.dryAllStrokes()},t.prototype.setStrokeErasing=function(){this.enableLassoSelectManipulation&&this.stopLassoSelectManipulationInput(),this.outputSwitcher.normalOutput=this.strokeEraser,this.store.strokeBeginEndListener.dryAllStrokes()},t.prototype.setPointErasing=function(){this.enableLassoSelectManipulation&&this.stopLassoSelectManipulationInput(),this.outputSwitcher.normalOutput=this.pointEraser,this.pointEraser.setInkStore(this.store),this.store.strokeBeginEndListener.dryAllStrokes()},t.prototype.setDrawing=function(){this.enableLassoSelectManipulation&&this.stopLassoSelectManipulationInput(),this.outputSwitcher.normalOutput=this.drawer},t.prototype.setLassoing=function(){this.enableLassoSelectManipulation&&this.startLassoSelectManipulationInput(),this.outputSwitcher.normalOutput=this.lasso,this.store.strokeBeginEndListener.dryAllStrokes()},t.prototype.updateZoom=function(t){this.zoom=t},t.prototype.startLassoSelectManipulationInput=function(){var t;this.isLassoing=!0,this.isPenOnly&&(this.pointerOverOut.deactivate(),this.pointerActivation.deactivate()),null===(t=this.enableInputOnPointerDown)||void 0===t||t.activate(),c(this.wetCanvas)},t.prototype.stopLassoSelectManipulationInput=function(){var t;this.isLassoing=!1,null===(t=this.enableInputOnPointerDown)||void 0===t||t.deactivate(),this.isPenOnly?(this.pointerActivation.activate(),this.pointerOverOut.activate()):u(this.wetCanvas)},t}();class Ki{constructor(){this.modifier=t=>t}setDrawingAttributes(t){this.output.setDrawingAttributes(this.modifier(t))}beginStroke(t){this.output.beginStroke(t)}addPoint(t){this.output.addPoint(t)}endStroke(t){this.output.endStroke(t)}}class qi{constructor(t,e){this.isLoopActive=!1,this.animationCallback=()=>{this.delegate(),this.isLoopActive&&this.window.requestAnimationFrame(this.animationCallback)},this.delegate=t,this.window=null!=e?e:window}onStrokeBegin(){this.isLoopActive=!0,this.window.requestAnimationFrame(this.animationCallback)}onStrokeEnd(){this.isLoopActive=!1}}function Ji(t){throw t}class Zi{constructor(t){this.context=t}beginPath(){this.context.beginPath()}arc(t,e,i,n,s,o){this.context.arc(t,e,i,n,s,o)}circularArc(t,e,i,n,s,o,r,a,h){let u=Math.atan2(e-n,t-i),c=Math.atan2(r-n,o-i);u=u<0?2*Math.PI+u:u,c=c<0?2*Math.PI+c:c,this.arc(i,n,s,u,c,h)}lineTo(t,e){this.context.lineTo(t,e)}moveTo(t,e){this.context.moveTo(t,e)}closePath(){this.context.closePath()}}class Qi{constructor(t,e,i){this.incomingTangent1={x:Number.NaN,y:Number.NaN},this.incomingTangent2={x:Number.NaN,y:Number.NaN},this.outgoingTangent1={x:Number.NaN,y:Number.NaN},this.outgoingTangent2={x:Number.NaN,y:Number.NaN},this.center={x:t,y:e},this.radius=i}}class tn{constructor(t,e){this.stroke=[],this.builder=t,this.tipRadius=e.width/2}beginStroke(t){this.builder.beginPath(),this.stroke=[],this.addPoint(t)}addPoint(t){const e=new Qi(t.x,t.y,this.tipRadius*It(t.pressure));this.stroke.push(e)}endStroke(t){this.addPoint(t),function(t){for(let e=1;e<t.length;e++){const i=t[e-1],n=t[e],s=i.center.x,o=i.center.y,r=i.radius,a=n.center.x,h=n.center.y,u=n.radius,c=s-a,l=o-h,p=Math.sqrt(c*c+l*l),d=Math.abs(u-r);if(d>p)continue;const f=1/p,g=d*f;let m=Math.sqrt(1-g*g),v=c*f,y=l*f;r>u&&(m=-m,v=-v,y=-y);const S=v*g,w=y*g,P=v*m,k=y*m,x=S+k,b=w-P,E=S-k,T=w+P;i.outgoingTangent1.x=s+r*x,i.outgoingTangent1.y=o+r*b,i.outgoingTangent2.x=s+r*E,i.outgoingTangent2.y=o+r*T,n.incomingTangent1.x=a+u*x,n.incomingTangent1.y=h+u*b,n.incomingTangent2.x=a+u*E,n.incomingTangent2.y=h+u*T}}(this.stroke),function(t,e){let i=0;for(let n=0;n<e.length;n++)(n===e.length-1||isNaN(e[n].outgoingTangent1.x))&&(en(t,e,i,n),i=n+1)}(this.builder,this.stroke),this.builder.closePath()}}function en(t,e,i,n){if(i===n){const n=e[i];return t.moveTo(n.center.x-n.radius,n.center.y),t.circularArc(n.center.x-n.radius,n.center.y,n.center.x,n.center.y,n.radius,n.center.x+n.radius,n.center.y,!1,!0),void t.circularArc(n.center.x+n.radius,n.center.y,n.center.x,n.center.y,n.radius,n.center.x-n.radius,n.center.y,!1,!0)}let s=e[i];t.moveTo(s.outgoingTangent1.x,s.outgoingTangent1.y);let o,r=s;s=e[i+1];for(let a=i+1;a<n;a++){o=e[a+1];const i=nn(r.outgoingTangent1,s.incomingTangent1,s.outgoingTangent1,o.incomingTangent1);void 0!==i?t.lineTo(i.x,i.y):(t.lineTo(s.incomingTangent1.x,s.incomingTangent1.y),t.circularArc(s.incomingTangent1.x,s.incomingTangent1.y,s.center.x,s.center.y,s.radius,s.outgoingTangent1.x,s.outgoingTangent1.y,!1,!0)),r=s,s=o}const a=s.radius>e[n-1].radius;t.lineTo(s.incomingTangent1.x,s.incomingTangent1.y),t.circularArc(s.incomingTangent1.x,s.incomingTangent1.y,s.center.x,s.center.y,s.radius,s.incomingTangent2.x,s.incomingTangent2.y,a,!0),r=s,s=e[n-1];for(let a=n-1;a>i;a--){o=e[a-1];const i=nn(r.incomingTangent2,s.outgoingTangent2,s.incomingTangent2,o.outgoingTangent2);void 0!==i?t.lineTo(i.x,i.y):(t.lineTo(s.outgoingTangent2.x,s.outgoingTangent2.y),t.circularArc(s.outgoingTangent2.x,s.outgoingTangent2.y,s.center.x,s.center.y,s.radius,s.incomingTangent2.x,s.incomingTangent2.y,!1,!0)),r=s,s=o}const h=s.radius>e[i+1].radius;t.lineTo(s.outgoingTangent2.x,s.outgoingTangent2.y),t.circularArc(s.outgoingTangent2.x,s.outgoingTangent2.y,s.center.x,s.center.y,s.radius,s.outgoingTangent1.x,s.outgoingTangent1.y,h,!0)}function nn(t,e,i,n){if((n.x-i.x)*(e.y-t.y)-(e.x-t.x)*(n.y-i.y)>0)return;const s=e.y-t.y,o=t.x-e.x,r=s*t.x+o*t.y,a=n.y-i.y,h=i.x-n.x,u=a*i.x+h*i.y,c=s*h-a*o;if(St(c)){const l=1/c,p=(h*r-o*u)*l,d=(s*u-a*r)*l;if(sn(p,d,t,e)&&sn(p,d,i,n))return{x:p,y:d}}}function sn(t,e,i,n){return(Math.min(i.x,n.x)<t||wt(Math.min(i.x,n.x),t))&&(Math.max(i.x,n.x)>t||wt(Math.max(i.x,n.x),t))&&(Math.min(i.y,n.y)<e||wt(Math.min(i.y,n.y),e))&&(Math.max(i.y,n.y)>e||wt(Math.max(i.y,n.y),e))}const on=2*Math.PI;function rn(t,e,i){t.arc(e.x,e.y,i,0,on)}function an(t,e,i,n){const s=e.x-i,o=e.x+i,r=e.y-n,a=e.y+n;t.moveTo(s,r),t.lineTo(o,r),t.lineTo(o,a),t.lineTo(s,a),t.lineTo(s,r)}function hn(t,e){t.moveTo(e.p1.x,e.p1.y),t.lineTo(e.p2.x,e.p2.y),t.lineTo(e.p3.x,e.p3.y),t.lineTo(e.p4.x,e.p4.y),t.lineTo(e.p1.x,e.p1.y)}class un{constructor(t,e){this.quad={p1:{x:0,y:0},p2:{x:0,y:0},p3:{x:0,y:0},p4:{x:0,y:0}},this.builder=t,this.tipRadius=e.width/2}beginStroke(t){this.builder.beginPath(),this.updateRadius(t),rn(this.builder,t,this.radius),this.lastPoint=t}addPoint(t){this.updateRadius(t),function(t,e,i,n,s){const o=i.x-t.x,r=i.y-t.y,a=Math.sqrt(o*o+r*r);if(a<=Math.abs(n-e))return!1;const h=o/a,u=-r/a,c=(n-e)/a,l=Math.sqrt(1-c*c),p=u*l+h*c,d=h*l-u*c,f=u*l-h*c,g=h*l+u*c;return s.p1.x=t.x-p*e,s.p1.y=t.y-d*e,s.p2.x=i.x-p*n,s.p2.y=i.y-d*n,s.p3.x=i.x+f*n,s.p3.y=i.y+g*n,s.p4.x=t.x+f*e,s.p4.y=t.y+g*e,!0}(t,this.radius,this.lastPoint,this.lastRadius,this.quad)&&(hn(this.builder,this.quad),rn(this.builder,t,this.radius)),this.lastPoint=t}endStroke(t){this.addPoint(t),this.builder.closePath()}updateRadius(t){this.lastRadius=this.radius,this.radius=this.tipRadius*It(t.pressure)}}class cn{constructor(t){this.builder=t}beginStroke(t){this.builder.beginPath(),this.builder.moveTo(t.x,t.y)}addPoint(t){this.builder.lineTo(t.x,t.y)}endStroke(t){this.addPoint(t)}}function ln(t,e,i,n,s,o,r){const a=t.x-e,h=t.y-i,u=t.x+e,c=t.y+i,l=n.x-s,p=n.y-o,d=n.x+s,f=n.y+o;if(l>=a&&p>=h&&d<=u&&f<=c||a>=l&&h>=p&&u<=d&&c<=f)return!1;const g=n.x-t.x>0?1:-1,m=n.y-t.y>0?1:-1;return r.p1.x=t.x-m*e,r.p1.y=t.y+g*i,r.p2.x=t.x+m*e,r.p2.y=t.y-g*i,r.p3.x=n.x+m*s,r.p3.y=n.y-g*o,r.p4.x=n.x-m*s,r.p4.y=n.y+g*o,!0}class pn{constructor(t,e,i,n){this.center={x:t,y:e},this.halfWidth=i,this.halfHeight=n}}class dn{constructor(t,e){this.stroke=[],this.quads=[],this.builder=t,this.tipWidth=e.width/2,this.tipHeight=e.height/2}beginStroke(t){this.builder.beginPath(),this.stroke=[],this.quads=[],this.addPoint(t)}addPoint(t){const e=It(t.pressure),i=new pn(t.x,t.y,this.tipWidth*e,this.tipHeight*e),n=this.stroke.length;n>0&&function(t,e,i){const n={p1:{x:0,y:0},p2:{x:0,y:0},p3:{x:0,y:0},p4:{x:0,y:0}};ln(t.center,t.halfWidth,t.halfHeight,e.center,e.halfWidth,e.halfHeight,n)&&i.push(n)}(this.stroke[n-1],i,this.quads),this.stroke.push(i)}endStroke(t){this.addPoint(t),function(t,e,i){if(fn(t,e[0]),0!==i.length){t.moveTo(i[0].p1.x,i[0].p1.y);for(let e=0;e<i.length;e++)t.lineTo(i[e].p2.x,i[e].p2.y),t.lineTo(i[e].p3.x,i[e].p3.y);for(let e=i.length-1;e>=0;e--)t.lineTo(i[e].p4.x,i[e].p4.y),t.lineTo(i[e].p1.x,i[e].p1.y);e.length>2&&fn(t,e[e.length-2]),fn(t,e[e.length-1])}}(this.builder,this.stroke,this.quads),this.builder.closePath()}}function fn(t,e){an(t,e.center,e.halfWidth,e.halfHeight)}class gn{constructor(t,e){this.quad={p1:{x:0,y:0},p2:{x:0,y:0},p3:{x:0,y:0},p4:{x:0,y:0}},this.builder=t,this.tipHalfWidth=e.width/2,this.tipHalfHeight=e.height/2}beginStroke(t){this.builder.beginPath(),this.updateSize(t),an(this.builder,t,this.halfWidth,this.halfHeight),this.lastPoint=t}addPoint(t){this.updateSize(t),ln(t,this.halfWidth,this.halfHeight,this.lastPoint,this.lastHalfWidth,this.lastHalfHeight,this.quad)&&(hn(this.builder,this.quad),an(this.builder,t,this.halfWidth,this.halfHeight)),this.lastPoint=t}endStroke(t){this.addPoint(t),this.builder.closePath()}updateSize(t){this.lastHalfWidth=this.halfWidth,this.lastHalfHeight=this.halfHeight;const e=It(t.pressure);this.halfWidth=this.tipHalfWidth*e,this.halfHeight=this.tipHalfHeight*e}}class mn{constructor(t,e,i=new Ee){this.renderMode=0,this.context=t,this.canvasPathBuilder=new Zi(t),this.effectResolver=e,this.colorResolver=i}setDrawingAttributes(t){this.attributes=t}beginStroke(t){this.pathBuilder=this.makeNewPathBuilder(),this.pathBuilder.beginStroke(t),this.beginPoint=t}addPoint(t){this.pathBuilder.addPoint(t)}endStroke(t){this.pathBuilder.endStroke(t),this.context.save(),function(t,e,i,n,s){t.lineWidth=e.height;const o=function(t,e,i,n,s){if(1===e.effect.type){const n=e.effect,o=i.toCanvasImageSource(n);if(void 0!==o){const i=t.createPattern(o,"repeat");if(null!==i){const o=.5;return t.scale(o,o),t.lineWidth=e.width/o,t.translate(s.x-n.offsetX,s.y-n.offsetY),i}}}return n.toCSSColor(e.color,e)}(t,e,i,n,s);switch(t.strokeStyle=o,t.fillStyle=o,e.tip){case"ellipse":t.lineCap="round",t.lineJoin="round";break;case"rectangle":t.lineCap="butt",t.lineJoin="miter";break;default:Ji(e.tip)}switch(e.rasterOperation){case"copy":t.globalCompositeOperation="source-over";break;case"mask":t.globalCompositeOperation="darken";break;case"clear":t.globalCompositeOperation="destination-out";break;default:Ji(e.rasterOperation)}}(this.context,this.attributes,this.effectResolver,this.colorResolver,this.beginPoint),2===this.renderMode?this.context.stroke():this.context.fill(),this.context.restore()}makeNewPathBuilder(){switch(this.renderMode){case 0:return"ellipse"===this.attributes.tip?new un(this.canvasPathBuilder,this.attributes):new gn(this.canvasPathBuilder,this.attributes);case 1:return"ellipse"===this.attributes.tip?new tn(this.canvasPathBuilder,this.attributes):new dn(this.canvasPathBuilder,this.attributes);case 2:return new cn(this.canvasPathBuilder);default:Ji(this.renderMode)}}}class vn{toCanvasImageSource(){}toSVGImageElementId(){}}function yn(t){var e=new mn(t,new vn);if(h())return e;var i=new Ki;return i.modifier=function(t){return"mask"===t.rasterOperation?new w(t).setColor(new m(t.color).setAlpha(.5).build()).build():t},N(i,e),i}var Sn=function(){function t(t,e,i){var n=this;this.strokeBeginEndListener={onStrokeBegin:function(){n.renderLoop.onStrokeBegin()},onStrokeEnd:function(){n.renderLoop.onStrokeEnd()}},this.incremental=!0,this.render=function(){n.incremental||n.clear(),n.store.collectChanges(n.transformer,n.incremental)},this.store=e,this.zoom=i>0?i:1,this.transformer=new Ki,this.wetContext=this.updateCanvasContext(this.zoom,t),this.wetRenderer=yn(this.wetContext),N(this.transformer,this.wetRenderer),this.renderLoop=new qi(this.render)}return t.prototype.updateCanvasContext=function(t,e){var i=this;return this.wetContext=ai(e,window.devicePixelRatio,e.clientWidth,e.clientHeight),this.zoom=t>0?t:1,this.transformer.modifier=function(t){return new w(t).setWidth(t.width*i.zoom).setHeight(t.height*i.zoom).build()},this.wetContext},t.prototype.clear=function(){si(this.wetContext)},t.prototype.setIncrementalRender=function(t){this.incremental=t},t}(),wn=function(){function t(t,e){var i=this;this.task=function(){},this.executeTask=function(){i.task(),i.isIEOrFF?requestAnimationFrame((function(){window.setTimeout((function(){i.renderer.clear()}),0)})):i.renderer.clear(),i.resetPendingTask()},this.renderer=t,this.idleTimeToDryInk=e,this.isIEOrFF=o()||r()}return t.prototype.onStrokeBegin=function(){this.renderer.strokeBeginEndListener.onStrokeBegin(),void 0!==this.timeoutTask&&this.resetPendingTask()},t.prototype.onStrokeEnd=function(){this.renderer.strokeBeginEndListener.onStrokeEnd(),this.timeoutTask=window.setTimeout(this.executeTask,this.idleTimeToDryInk)},t.prototype.dryAllStrokes=function(){this.executeTask(),this.resetPendingTask()},t.prototype.resetPendingTask=function(){window.clearTimeout(this.timeoutTask)},t}(),Pn=3.77953,kn=function(){function t(t,e,i,s,o,r,a,h,u,c,l){var p=this;this.toolType=0,this.isLineMode=!1,this.wetCanvas=function(t,e){var i=E();return i.width=e.clientWidth,i.height=e.clientHeight,i.style.touchAction="none",i.style.pointerEvents="none",i.style.position="absolute",i.style.top="0",i.style.left="0",t.appendChild(i),O.info("Canvas created: width:"+i.width+" height:"+i.height),i}(t,e),this.inkMinutesMetric=new b(n,1),R.INSTANCE.setSettings(l),this.enableLassoSelectManipulation=R.INSTANCE.getBooleanAppSetting("InkLassoSelectHandlesEnabled"),P||(new k(n,1,undefined),P=!0),this.targetElement=e,this.enableShiftStraightLine=u,this.store=new Bi(s),this.dryStore=o,this.dryStore.updateZoom(s),this.viewModelModifier=r,this.pipeline=new Gi(this.wetCanvas,i,this.store,o,this.wetCanvas,r,h,this.enableLassoSelectManipulation,(function(){return p.getDrawingHaptics()}),s,(function(t,e){return p.setLineMode(t,e)})),this.renderer=new Sn(this.wetCanvas,this.store,s),this.store.strokeBeginEndListener=new wn(this.renderer,a),this.store.initializeDryStrokesCallback(),this.attributes=new w,this.color=new m,this.setColor(c),this.selectPen(),this.zoom=s}return t.prototype.startPipeline=function(){this.pipeline.activate(),this.inkMinutesMetric.activate(this.wetCanvas)},t.prototype.stopPipeline=function(){this.renderer.clear(),this.pipeline.deactivate(),this.setDarkenMixBlendMode(!1),this.inkMinutesMetric.deactivate()},t.prototype.enableTouchMouse=function(){(!this.enableLassoSelectManipulation||this.enableLassoSelectManipulation&&!this.pipeline.isLassoMode())&&u(this.wetCanvas),this.pipeline.deactivatePenOnly()},t.prototype.disableTouchMouse=function(){this.pipeline.activatePenOnly(),(!this.enableLassoSelectManipulation||this.enableLassoSelectManipulation&&!this.pipeline.isLassoMode())&&c(this.wetCanvas)},t.prototype.setColor=function(t){this.attributes.setColor(this.color.setHexRGB(t).build()),this.pipeline.injector.setDrawingAttributes(this.attributes.build())},t.prototype.setThickness=function(t){switch(this.toolType){case 0:var e=(i=t,Math.min(13.22835,.94488*Math.pow(2,i-1)));this.attributes.setWidth(e).setHeight(e);break;case 1:e=function(t){return 7.55906*t}(t),this.attributes.setWidth(e/2).setHeight(e)}var i;this.pipeline.injector.setDrawingAttributes(this.attributes.build())},t.prototype.setStrokeSink=function(t){this.store.setStrokeSink(t)},t.prototype.setLineMode=function(t,e){this.enableShiftStraightLine&&(this.isLineMode=t,this.isLineMode&&n.logActivity("ShiftStraightLineUsage",0,["InputType"],[e.pointerType]),0!==this.toolType&&1!==this.toolType||this.renderer.setIncrementalRender(!this.isLineMode),this.store.setLineMode(t))},t.prototype.selectPen=function(){this.attributes.setColor(this.color.build()).setTip("ellipse").setRasterOperation("copy").setWidth(Pn).setHeight(Pn),this.pipeline.injector.setDrawingAttributes(this.attributes.build()),this.pipeline.setDrawing(),this.toolType=0,this.renderer.setIncrementalRender(!0),this.setDarkenMixBlendMode(!1),this.inkMinutesMetric.start(x.Pen)},t.prototype.selectHighlighter=function(){this.attributes.setColor(this.color.build()).setTip("rectangle").setRasterOperation("mask").setWidth(11.3386).setHeight(22.6772),this.pipeline.injector.setDrawingAttributes(this.attributes.build()),this.pipeline.setDrawing(),this.toolType=1,this.renderer.setIncrementalRender(h()),this.setDarkenMixBlendMode(!0),this.inkMinutesMetric.start(x.Highlighter)},t.prototype.selectEraser=function(){this.pipeline.setErasing(),this.viewModelModifier.clearSelection(),this.setDarkenMixBlendMode(!1),this.inkMinutesMetric.start(x.Erase)},t.prototype.selectStrokeEraser=function(){this.pipeline.setStrokeErasing(),this.viewModelModifier.clearSelection(),this.setDarkenMixBlendMode(!1),this.inkMinutesMetric.start(x.Erase)},t.prototype.selectPointEraser=function(){this.pipeline.setPointErasing(),this.renderer.setIncrementalRender(!0),this.inkMinutesMetric.start(x.Erase)},t.prototype.selectLasso=function(){this.attributes.setColor(this.color.build()).setTip("ellipse").setRasterOperation("copy").setWidth(Pn).setHeight(Pn),this.pipeline.injector.setDrawingAttributes(this.attributes.build()),this.pipeline.setLassoing(),this.setDarkenMixBlendMode(!1),this.inkMinutesMetric.start(x.Lasso)},t.prototype.toggleRuler=function(){null!==this.wetCanvas.parentElement&&(ii.INSTANCE.isActive()?ii.INSTANCE.deactivate():(function(t,e,i,n){var s;if(void 0===n&&(n=Qe),ei(n))ti(e,i,n);else{var o=C();o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.overflow="hidden",o.style.touchAction="none",o.style.pointerEvents="none",o.style.zIndex="1",o.setAttribute("width",""+e),o.setAttribute("height",""+i),o.setAttribute("id",n),null===(s=t.parentElement)||void 0===s||s.appendChild(o)}}(this.wetCanvas.parentElement,this.targetElement.clientWidth,this.targetElement.clientHeight),ii.INSTANCE.activate(this.zoom)))},t.prototype.updateCanvasDimensions=function(){this.wetCanvas.style.width=this.targetElement.clientWidth+"px",this.wetCanvas.style.height=this.targetElement.clientHeight+"px",this.renderer.updateCanvasContext(this.zoom,this.wetCanvas),null!==this.wetCanvas.parentElement&&ii.INSTANCE.isActive()&&ti(this.targetElement.clientWidth,this.targetElement.clientHeight)},t.prototype.updateCanvasZoom=function(t){this.zoom=t,this.dryStore.updateZoom(t),this.pipeline.updateZoom(t),this.renderer.updateCanvasContext(this.zoom,this.wetCanvas),this.store.updateZoom(t),null!==this.wetCanvas.parentElement&&ii.INSTANCE.isActive()&&ii.INSTANCE.setScale(t)},t.prototype.dryAllStrokes=function(){this.store.strokeBeginEndListener.dryAllStrokes()},t.prototype.isLassoMode=function(){return this.pipeline.isLassoMode()},t.prototype.setDarkenMixBlendMode=function(t){null!==this.wetCanvas.parentElement&&this.wetCanvas.parentElement.style.setProperty("mix-blend-mode",t?"darken":"normal")},t.prototype.getDrawingHaptics=function(){return"rectangle"===this.attributes.build().tip?i.WAVEFORM_MARKER_CONTINUOUS:i.WAVEFORM_INK_CONTINUOUS},t}(),xn=function(){function t(){}return t.prototype.createEditorInkCanvas=function(t,e,i,n,s,o,r,a,h,u,c){return new kn(t,e,i,n,s,o,r,a,h,u,c)},t.prototype.setLogger=function(t){D(t)},t.prototype.setActivityLogger=function(t){s(t)},t}(),bn=new xn;class En{constructor(t){this.threshold=t*t}beginStroke(t){this.basePoint=t,this.midPoint=t,this.output.beginStroke(t)}addPoint(t){ct(this.basePoint,t,this.midPoint)>this.threshold?(this.output.addPoint(this.midPoint),this.basePoint=this.midPoint,this.midPoint=t):(ht(this.basePoint,t)<ht(this.basePoint,this.midPoint)&&(this.output.addPoint(this.midPoint),this.basePoint=this.midPoint),this.midPoint=t)}endStroke(t){this.addPoint(t),this.output.endStroke(t)}}class Tn{constructor(t){this.points="",this.svgPolyline=t}setDrawingAttributes(t){this.svgPolyline.setAttribute("stroke-linecap","ellipse"===t.tip?"round":"square"),this.svgPolyline.setAttribute("stroke-width",""+2*t.width)}beginStroke(t){this.addPoint(t)}addPoint(t){this.points+=`${Math.round(t.x)},${Math.round(t.y)} `}endStroke(t){this.addPoint(t),this.svgPolyline.setAttribute("points",this.points),this.points=""}}function Mn(t){var e=0,i=me();return t.forEach((function(t){var n=mi(t.stroke);ye(i,n);var s=t.stroke.drawingAttributes;e=Math.max(e,s.width,s.height)})),{bounds:i,maxStrokeSize:e}}class In{constructor(t){this.modifier=new Ki,this.renderer=t,N(this.modifier,this.renderer)}add(t){this.modifier.modifier=t=>new w(t).setWidth(t.width+4.5).setHeight(t.height+4.5).build(),t.stream(this.modifier),this.modifier.modifier=t=>new w(t).setColor(f).setEffect(v).build(),t.stream(this.modifier)}}var An=function(){function t(){this.canvas=E()}return t.prototype.deserializeJSON=function(t){var e=[];try{return Oi(t).stream({add:function(t){e.push(new Yi(t))}}),e}catch(t){return O.info("Unable to deserialize JSON. Excepton: "+t),e}},t.prototype.rasterizeStrokeCollectionWithZoom=function(t,e,i){return O.info("rasterizeStrokeCollectionWithZoom strokeCount="+t.length+" zoom="+e+" isSelected="+i),function(t,e,i,n){if(0===e.length)return{imageData:"",width:0,height:0,padding:0,isHighlighter:!1};var s=Mn(e),o=s.bounds,r=s.maxStrokeSize,a=Math.ceil(2*r*i),h={left:o.left*i,top:o.top*i,right:o.right*i,bottom:o.bottom*i},u=Math.round(h.left),c=Math.round(h.top),l=Math.round(h.right)-u+2*a,p=Math.round(h.bottom)-c+2*a;t.width=l,t.height=p;var d=ai(t,window.devicePixelRatio,l,p);return d.translate(a+h.left-u,a+h.top-c),d.scale(i,i),d.translate(-o.left,-o.top),function(t,e,i){if(e){var n=new In(new mn(t,new vn));i.forEach((function(t){n.add(t.stroke)}))}else{var s=yn(t);i.forEach((function(t){t.stroke.stream(s)}))}}(d,n,e),{imageData:t.toDataURL("image/png"),width:l,height:p,padding:a,isHighlighter:e.length>0&&"mask"===e[0].stroke.drawingAttributes.rasterOperation}}(this.canvas,t,e,i)},t.prototype.generateStrokeCollectionHitTestElement=function(t){return function(t){if(0===t.length)return{svgHitTestOverlay:C(),padding:0};var e=Mn(t),i=e.bounds,n=e.maxStrokeSize,s=Math.ceil(2*n),o=Math.round(i.right-i.left),r=Math.round(i.bottom-i.top),a=o+2*s,h=r+2*s,u=C();return t.forEach((function(t){var e=T("polyline");u.setAttribute("width",""+a),u.setAttribute("height",""+h),e.setAttribute("stroke","black"),e.setAttribute("stroke-opacity","0.0"),e.setAttribute("fill","none"),u.appendChild(e);var n=new Tn(e),s=new En(.7),o=new vt;o.transform=Ri(-i.left,-i.top),U(s,o,n),n.setDrawingAttributes(t.stroke.drawingAttributes),t.stroke.streamPath(s)})),u.setAttribute("viewBox","-"+s+" -"+s+" "+a+" "+h),{svgHitTestOverlay:u,padding:s}}(t)},t.prototype.containsPencilInkContent=function(t){var e=!1;return t.forEach((function(t){2===t.stroke.drawingAttributes.effect.type&&(e=!0)})),e},t}(),Cn=new(function(){function t(){}return t.prototype.createEditorInkStrokeRasterizer=function(){return new An},t}()),Ln=new(function(){function t(){}return t.prototype.createEditorInkDryStore=function(t,e){return new zi(t,e)},t}());ink=e})();
//# sourceMappingURL=ink.js.map